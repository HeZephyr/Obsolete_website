<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>比例份额调度 | Pursuit&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="随便写写">
    <meta name="keywords" content="python,Go,C++,git,github,markdown,database,mysql,redis">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.a3990aec.css" as="style"><link rel="preload" href="/assets/js/app.bf22d313.js" as="script"><link rel="preload" href="/assets/js/4.71a85121.js" as="script"><link rel="preload" href="/assets/js/1.4a1189e9.js" as="script"><link rel="preload" href="/assets/js/3.bca043f9.js" as="script"><link rel="preload" href="/assets/js/109.b30c73e0.js" as="script"><link rel="preload" href="/assets/js/20.bc1029fc.js" as="script"><link rel="prefetch" href="/assets/js/10.ce2d8b4d.js"><link rel="prefetch" href="/assets/js/100.c6b7de61.js"><link rel="prefetch" href="/assets/js/101.a1952818.js"><link rel="prefetch" href="/assets/js/102.837bf460.js"><link rel="prefetch" href="/assets/js/103.94fdd963.js"><link rel="prefetch" href="/assets/js/104.acbbd1e2.js"><link rel="prefetch" href="/assets/js/105.eae4e099.js"><link rel="prefetch" href="/assets/js/106.cff8eabf.js"><link rel="prefetch" href="/assets/js/107.2bcc8651.js"><link rel="prefetch" href="/assets/js/108.47b5cd4a.js"><link rel="prefetch" href="/assets/js/11.87208a0c.js"><link rel="prefetch" href="/assets/js/110.11617855.js"><link rel="prefetch" href="/assets/js/111.0eb20766.js"><link rel="prefetch" href="/assets/js/112.07452da9.js"><link rel="prefetch" href="/assets/js/113.d7c6b561.js"><link rel="prefetch" href="/assets/js/114.a7761af9.js"><link rel="prefetch" href="/assets/js/115.e276743d.js"><link rel="prefetch" href="/assets/js/116.893ee4c4.js"><link rel="prefetch" href="/assets/js/117.8fe66ede.js"><link rel="prefetch" href="/assets/js/118.1413d99e.js"><link rel="prefetch" href="/assets/js/119.2303fc76.js"><link rel="prefetch" href="/assets/js/12.7f5cceef.js"><link rel="prefetch" href="/assets/js/120.f50d7974.js"><link rel="prefetch" href="/assets/js/121.693fe9db.js"><link rel="prefetch" href="/assets/js/122.825badd2.js"><link rel="prefetch" href="/assets/js/123.ac5cff17.js"><link rel="prefetch" href="/assets/js/124.d2a351c7.js"><link rel="prefetch" href="/assets/js/125.36b4e9a5.js"><link rel="prefetch" href="/assets/js/126.f3bc4c16.js"><link rel="prefetch" href="/assets/js/127.f72b1a4f.js"><link rel="prefetch" href="/assets/js/128.d8d9bc68.js"><link rel="prefetch" href="/assets/js/129.53d2b635.js"><link rel="prefetch" href="/assets/js/13.f2cea533.js"><link rel="prefetch" href="/assets/js/130.1dc6d120.js"><link rel="prefetch" href="/assets/js/131.f1ff6308.js"><link rel="prefetch" href="/assets/js/132.80757a9c.js"><link rel="prefetch" href="/assets/js/133.27a18f5d.js"><link rel="prefetch" href="/assets/js/134.0a18c136.js"><link rel="prefetch" href="/assets/js/135.339fbb7d.js"><link rel="prefetch" href="/assets/js/136.a53f9873.js"><link rel="prefetch" href="/assets/js/137.12db62b0.js"><link rel="prefetch" href="/assets/js/138.eebd39fe.js"><link rel="prefetch" href="/assets/js/139.038c217c.js"><link rel="prefetch" href="/assets/js/14.f8459573.js"><link rel="prefetch" href="/assets/js/140.03946f8a.js"><link rel="prefetch" href="/assets/js/141.cea1a41c.js"><link rel="prefetch" href="/assets/js/142.62dab267.js"><link rel="prefetch" href="/assets/js/143.1e9e2b0f.js"><link rel="prefetch" href="/assets/js/144.f2efd35f.js"><link rel="prefetch" href="/assets/js/145.11a31f5f.js"><link rel="prefetch" href="/assets/js/146.e363c390.js"><link rel="prefetch" href="/assets/js/147.ff066c84.js"><link rel="prefetch" href="/assets/js/148.59bfffb4.js"><link rel="prefetch" href="/assets/js/149.92ae23e9.js"><link rel="prefetch" href="/assets/js/15.06cd6cc8.js"><link rel="prefetch" href="/assets/js/150.f95206e8.js"><link rel="prefetch" href="/assets/js/151.31dd32bd.js"><link rel="prefetch" href="/assets/js/152.08c63a7b.js"><link rel="prefetch" href="/assets/js/153.3412415d.js"><link rel="prefetch" href="/assets/js/154.cfa5d205.js"><link rel="prefetch" href="/assets/js/155.fe2984c4.js"><link rel="prefetch" href="/assets/js/156.a7184e68.js"><link rel="prefetch" href="/assets/js/157.feca608b.js"><link rel="prefetch" href="/assets/js/158.892f9f19.js"><link rel="prefetch" href="/assets/js/159.d0bd5ee4.js"><link rel="prefetch" href="/assets/js/16.33942615.js"><link rel="prefetch" href="/assets/js/160.b053cf7f.js"><link rel="prefetch" href="/assets/js/161.8399fee4.js"><link rel="prefetch" href="/assets/js/162.2e6412db.js"><link rel="prefetch" href="/assets/js/163.2f5cf90e.js"><link rel="prefetch" href="/assets/js/164.da241573.js"><link rel="prefetch" href="/assets/js/165.bbca82ee.js"><link rel="prefetch" href="/assets/js/166.567e34e1.js"><link rel="prefetch" href="/assets/js/167.77360d51.js"><link rel="prefetch" href="/assets/js/168.459b1b54.js"><link rel="prefetch" href="/assets/js/169.5b4040b3.js"><link rel="prefetch" href="/assets/js/17.da2e0126.js"><link rel="prefetch" href="/assets/js/170.57b36e66.js"><link rel="prefetch" href="/assets/js/171.2fd5c08f.js"><link rel="prefetch" href="/assets/js/172.5c164d95.js"><link rel="prefetch" href="/assets/js/173.94a3f011.js"><link rel="prefetch" href="/assets/js/174.f935c1bd.js"><link rel="prefetch" href="/assets/js/175.88cdd60c.js"><link rel="prefetch" href="/assets/js/176.a1808e7d.js"><link rel="prefetch" href="/assets/js/177.2a07cf9b.js"><link rel="prefetch" href="/assets/js/178.ad9a4057.js"><link rel="prefetch" href="/assets/js/179.9660f6e4.js"><link rel="prefetch" href="/assets/js/18.a39b8ae2.js"><link rel="prefetch" href="/assets/js/180.11dc6574.js"><link rel="prefetch" href="/assets/js/181.66ebaad2.js"><link rel="prefetch" href="/assets/js/182.bb310d8a.js"><link rel="prefetch" href="/assets/js/183.01eceb36.js"><link rel="prefetch" href="/assets/js/184.532e491f.js"><link rel="prefetch" href="/assets/js/185.dd122ad8.js"><link rel="prefetch" href="/assets/js/186.8fc1274d.js"><link rel="prefetch" href="/assets/js/187.4b297d09.js"><link rel="prefetch" href="/assets/js/19.1760f287.js"><link rel="prefetch" href="/assets/js/2.8e76b5b7.js"><link rel="prefetch" href="/assets/js/21.4b161474.js"><link rel="prefetch" href="/assets/js/22.69d29451.js"><link rel="prefetch" href="/assets/js/23.2a87052f.js"><link rel="prefetch" href="/assets/js/24.6beeaf9b.js"><link rel="prefetch" href="/assets/js/25.e9d4e312.js"><link rel="prefetch" href="/assets/js/26.c128f1d5.js"><link rel="prefetch" href="/assets/js/27.2bab9253.js"><link rel="prefetch" href="/assets/js/28.0b0ea581.js"><link rel="prefetch" href="/assets/js/29.71a2a1e9.js"><link rel="prefetch" href="/assets/js/30.11fd1987.js"><link rel="prefetch" href="/assets/js/31.92abb231.js"><link rel="prefetch" href="/assets/js/32.27d7c672.js"><link rel="prefetch" href="/assets/js/33.9f002fe8.js"><link rel="prefetch" href="/assets/js/34.39abd7b3.js"><link rel="prefetch" href="/assets/js/35.a54492ae.js"><link rel="prefetch" href="/assets/js/36.1b3ef370.js"><link rel="prefetch" href="/assets/js/37.3dda47b6.js"><link rel="prefetch" href="/assets/js/38.3dc3656a.js"><link rel="prefetch" href="/assets/js/39.78160c0e.js"><link rel="prefetch" href="/assets/js/40.382841f8.js"><link rel="prefetch" href="/assets/js/41.885f2f51.js"><link rel="prefetch" href="/assets/js/42.a794deca.js"><link rel="prefetch" href="/assets/js/43.bd06b1c5.js"><link rel="prefetch" href="/assets/js/44.c5b9fce0.js"><link rel="prefetch" href="/assets/js/45.8e169e05.js"><link rel="prefetch" href="/assets/js/46.907fb663.js"><link rel="prefetch" href="/assets/js/47.b494d092.js"><link rel="prefetch" href="/assets/js/48.7c4206ed.js"><link rel="prefetch" href="/assets/js/49.16bab940.js"><link rel="prefetch" href="/assets/js/5.780a742d.js"><link rel="prefetch" href="/assets/js/50.bf2afa43.js"><link rel="prefetch" href="/assets/js/51.0a1e84c2.js"><link rel="prefetch" href="/assets/js/52.59a39ef7.js"><link rel="prefetch" href="/assets/js/53.572697e9.js"><link rel="prefetch" href="/assets/js/54.fc2487d6.js"><link rel="prefetch" href="/assets/js/55.e141f0c8.js"><link rel="prefetch" href="/assets/js/56.7e333e13.js"><link rel="prefetch" href="/assets/js/57.65140fab.js"><link rel="prefetch" href="/assets/js/58.4f519804.js"><link rel="prefetch" href="/assets/js/59.8d7b46a7.js"><link rel="prefetch" href="/assets/js/6.6c206683.js"><link rel="prefetch" href="/assets/js/60.51f050d8.js"><link rel="prefetch" href="/assets/js/61.d0be8bfb.js"><link rel="prefetch" href="/assets/js/62.a15c3ffa.js"><link rel="prefetch" href="/assets/js/63.d178adeb.js"><link rel="prefetch" href="/assets/js/64.1de53088.js"><link rel="prefetch" href="/assets/js/65.1f66b952.js"><link rel="prefetch" href="/assets/js/66.3d9ec4f6.js"><link rel="prefetch" href="/assets/js/67.c25c7eea.js"><link rel="prefetch" href="/assets/js/68.c2233d35.js"><link rel="prefetch" href="/assets/js/69.b5a9f3d3.js"><link rel="prefetch" href="/assets/js/7.03420b55.js"><link rel="prefetch" href="/assets/js/70.d651fd44.js"><link rel="prefetch" href="/assets/js/71.16881e1e.js"><link rel="prefetch" href="/assets/js/72.ea2a2f74.js"><link rel="prefetch" href="/assets/js/73.4082041c.js"><link rel="prefetch" href="/assets/js/74.48e511ca.js"><link rel="prefetch" href="/assets/js/75.59b2157d.js"><link rel="prefetch" href="/assets/js/76.285801a4.js"><link rel="prefetch" href="/assets/js/77.a26a0c17.js"><link rel="prefetch" href="/assets/js/78.bdb45583.js"><link rel="prefetch" href="/assets/js/79.3bce4a31.js"><link rel="prefetch" href="/assets/js/80.6b49a79a.js"><link rel="prefetch" href="/assets/js/81.a4b9d26e.js"><link rel="prefetch" href="/assets/js/82.1079fef2.js"><link rel="prefetch" href="/assets/js/83.cfaa864c.js"><link rel="prefetch" href="/assets/js/84.8e869aa2.js"><link rel="prefetch" href="/assets/js/85.ea42d8a3.js"><link rel="prefetch" href="/assets/js/86.a948fda8.js"><link rel="prefetch" href="/assets/js/87.ec5eefd3.js"><link rel="prefetch" href="/assets/js/88.a3c0617a.js"><link rel="prefetch" href="/assets/js/89.674cd71f.js"><link rel="prefetch" href="/assets/js/90.a8421d15.js"><link rel="prefetch" href="/assets/js/91.e3bff157.js"><link rel="prefetch" href="/assets/js/92.655c454e.js"><link rel="prefetch" href="/assets/js/93.9e8d559d.js"><link rel="prefetch" href="/assets/js/94.196e4c2a.js"><link rel="prefetch" href="/assets/js/95.30a85f63.js"><link rel="prefetch" href="/assets/js/96.1318b23d.js"><link rel="prefetch" href="/assets/js/97.984ad933.js"><link rel="prefetch" href="/assets/js/98.bb7f6e86.js"><link rel="prefetch" href="/assets/js/99.7a4682f0.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.caeb3b49.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a3990aec.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpeg" alt="Pursuit's blog" class="logo"> <span class="site-name can-hide">Pursuit's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发" class="dropdown-title"><a href="/develop/" class="link-title">开发</a> <span class="title" style="display:none;">开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/develop/language/" class="nav-link">编程语言</a></li><li class="dropdown-item"><!----> <a href="/develop/framework/" class="nav-link">开发框架</a></li><li class="dropdown-item"><!----> <a href="/develop/algorithm/" class="nav-link">数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/develop/storage/" class="nav-link">数据存储</a></li><li class="dropdown-item"><!----> <a href="/develop/system/" class="nav-link">系统架构</a></li><li class="dropdown-item"><!----> <a href="/develop/network/" class="nav-link">计算机网络</a></li><li class="dropdown-item"><!----> <a href="/develop/cloud/" class="nav-link">云原生</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><a href="/tool/" class="link-title">工具</a> <span class="title" style="display:none;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tool/vcs/" class="nav-link">版本控制</a></li><li class="dropdown-item"><!----> <a href="/tool/network/" class="nav-link">网络工具</a></li><li class="dropdown-item"><!----> <a href="/tool/develop/" class="nav-link">开发工具</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><a href="/note/" class="link-title">学习笔记</a> <span class="title" style="display:none;">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/paper/" class="nav-link">学术搬砖</a></li><li class="dropdown-item"><!----> <a href="/note/project/" class="nav-link">实践项目</a></li><li class="dropdown-item"><!----> <a href="/note/lecture/" class="nav-link">讲座研讨</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="生活杂谈" class="dropdown-title"><a href="/life/" class="link-title">生活杂谈</a> <span class="title" style="display:none;">生活杂谈</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/life/year/" class="nav-link">随写编年</a></li><li class="dropdown-item"><!----> <a href="/life/youth/" class="nav-link">追忆青春</a></li><li class="dropdown-item"><!----> <a href="/life/travel/" class="nav-link">旅行日记</a></li><li class="dropdown-item"><!----> <a href="/life/art/" class="nav-link">文艺时光</a></li><li class="dropdown-item"><!----> <a href="/life/cook/" class="nav-link">烹调分享</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="资源收藏" class="dropdown-title"><a href="/resource/" class="link-title">资源收藏</a> <span class="title" style="display:none;">资源收藏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/resource/website/" class="nav-link">实用网站</a></li><li class="dropdown-item"><!----> <a href="/resource/project/" class="nav-link">优秀项目</a></li><li class="dropdown-item"><!----> <a href="/resource/study/" class="nav-link">学习资源</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/more/interview/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/more/tip/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/more/blog/" class="nav-link">博客相关</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friend/" class="nav-link">友链</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/unique-pure/my-vdoing-blog-template" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar.jpeg"> <div class="blogger-info"><h3>Pursuit</h3> <span>但行好事，莫问前程</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发" class="dropdown-title"><a href="/develop/" class="link-title">开发</a> <span class="title" style="display:none;">开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/develop/language/" class="nav-link">编程语言</a></li><li class="dropdown-item"><!----> <a href="/develop/framework/" class="nav-link">开发框架</a></li><li class="dropdown-item"><!----> <a href="/develop/algorithm/" class="nav-link">数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/develop/storage/" class="nav-link">数据存储</a></li><li class="dropdown-item"><!----> <a href="/develop/system/" class="nav-link">系统架构</a></li><li class="dropdown-item"><!----> <a href="/develop/network/" class="nav-link">计算机网络</a></li><li class="dropdown-item"><!----> <a href="/develop/cloud/" class="nav-link">云原生</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><a href="/tool/" class="link-title">工具</a> <span class="title" style="display:none;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tool/vcs/" class="nav-link">版本控制</a></li><li class="dropdown-item"><!----> <a href="/tool/network/" class="nav-link">网络工具</a></li><li class="dropdown-item"><!----> <a href="/tool/develop/" class="nav-link">开发工具</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><a href="/note/" class="link-title">学习笔记</a> <span class="title" style="display:none;">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/paper/" class="nav-link">学术搬砖</a></li><li class="dropdown-item"><!----> <a href="/note/project/" class="nav-link">实践项目</a></li><li class="dropdown-item"><!----> <a href="/note/lecture/" class="nav-link">讲座研讨</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="生活杂谈" class="dropdown-title"><a href="/life/" class="link-title">生活杂谈</a> <span class="title" style="display:none;">生活杂谈</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/life/year/" class="nav-link">随写编年</a></li><li class="dropdown-item"><!----> <a href="/life/youth/" class="nav-link">追忆青春</a></li><li class="dropdown-item"><!----> <a href="/life/travel/" class="nav-link">旅行日记</a></li><li class="dropdown-item"><!----> <a href="/life/art/" class="nav-link">文艺时光</a></li><li class="dropdown-item"><!----> <a href="/life/cook/" class="nav-link">烹调分享</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="资源收藏" class="dropdown-title"><a href="/resource/" class="link-title">资源收藏</a> <span class="title" style="display:none;">资源收藏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/resource/website/" class="nav-link">实用网站</a></li><li class="dropdown-item"><!----> <a href="/resource/project/" class="nav-link">优秀项目</a></li><li class="dropdown-item"><!----> <a href="/resource/study/" class="nav-link">学习资源</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/more/interview/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/more/tip/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/more/blog/" class="nav-link">博客相关</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friend/" class="nav-link">友链</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/unique-pure/my-vdoing-blog-template" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程语言</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>开发框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据结构与算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据存储</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>系统架构</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>操作系统</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/77a74b/" class="sidebar-link">进程介绍</a></li><li><a href="/pages/1d4493/" class="sidebar-link">进程API</a></li><li><a href="/pages/4b8a3a/" class="sidebar-link">有限直接执行</a></li><li><a href="/pages/f0c724/" class="sidebar-link">CPU调度</a></li><li><a href="/pages/a1ad96/" class="sidebar-link">多级反馈队列</a></li><li><a href="/pages/40a229/" aria-current="page" class="active sidebar-link">比例份额调度</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/40a229/#_1-基本概念-彩票代表份额" class="sidebar-link">1 基本概念：彩票代表份额</a></li><li class="sidebar-sub-header level2"><a href="/pages/40a229/#_2-彩票机制" class="sidebar-link">2 彩票机制</a></li><li class="sidebar-sub-header level2"><a href="/pages/40a229/#_3-实现" class="sidebar-link">3 实现</a></li><li class="sidebar-sub-header level2"><a href="/pages/40a229/#_4-评估指标" class="sidebar-link">4 评估指标</a></li><li class="sidebar-sub-header level2"><a href="/pages/40a229/#_5-如何分配彩票" class="sidebar-link">5 如何分配彩票</a></li><li class="sidebar-sub-header level2"><a href="/pages/40a229/#_6-步幅调度" class="sidebar-link">6 步幅调度</a></li><li class="sidebar-sub-header level2"><a href="/pages/40a229/#_7-linux完全公平调度器-cfs" class="sidebar-link">7 Linux完全公平调度器（CFS）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/40a229/#_7-1-基本操作" class="sidebar-link">7.1 基本操作</a></li><li class="sidebar-sub-header level3"><a href="/pages/40a229/#_7-2-权重-优先级" class="sidebar-link">7.2 权重（优先级）</a></li><li class="sidebar-sub-header level3"><a href="/pages/40a229/#_7-3-使用红黑树" class="sidebar-link">7.3 使用红黑树</a></li><li class="sidebar-sub-header level3"><a href="/pages/40a229/#_7-4-处理i-o和休眠进程" class="sidebar-link">7.4 处理I/O和休眠进程</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/40a229/#_8-总结" class="sidebar-link">8 总结</a></li></ul></li><li><a href="/pages/326999/" class="sidebar-link">多CPU调度</a></li><li><a href="/pages/23b20c/" class="sidebar-link">地址空间</a></li><li><a href="/pages/174348/" class="sidebar-link">内存API</a></li><li><a href="/pages/542fcd/" class="sidebar-link">地址转换</a></li><li><a href="/pages/506cee/" class="sidebar-link">段</a></li><li><a href="/pages/d34e64/" class="sidebar-link">空闲空间管理</a></li><li><a href="/pages/69f0fb/" class="sidebar-link">页</a></li><li><a href="/pages/fe36b0/" class="sidebar-link">快表</a></li><li><a href="/pages/165f2d/" class="sidebar-link">高级页表</a></li><li><a href="/pages/65f57a/" class="sidebar-link">页面交换</a></li><li><a href="/pages/aeb7cb/" class="sidebar-link">交换策略</a></li><li><a href="/pages/9f0f28/" class="sidebar-link">完整VM系统</a></li><li><a href="/pages/1ef559/" class="sidebar-link">并发和线程</a></li><li><a href="/pages/2994ff/" class="sidebar-link">线程API</a></li><li><a href="/pages/fe4f25/" class="sidebar-link">锁</a></li><li><a href="/pages/396fa2/" class="sidebar-link">锁定数据结构</a></li><li><a href="/pages/463259/" class="sidebar-link">条件变量</a></li><li><a href="/pages/adf4ea/" class="sidebar-link">信号量</a></li><li><a href="/pages/a9671b/" class="sidebar-link">并发bug</a></li><li><a href="/pages/19d9ef/" class="sidebar-link">基于事件的并发</a></li><li><a href="/pages/628c92/" class="sidebar-link">IO设备</a></li><li><a href="/pages/8d5e59/" class="sidebar-link">硬盘驱动器</a></li><li><a href="/pages/04dd86/" class="sidebar-link">廉价磁盘冗余阵列</a></li><li><a href="/pages/1539cb/" class="sidebar-link">文件和目录</a></li><li><a href="/pages/a2ee8a/" class="sidebar-link">文件系统实现</a></li><li><a href="/pages/61d032/" class="sidebar-link">快速文件系统</a></li><li><a href="/pages/d2b72b/" class="sidebar-link">FSCK和日志</a></li><li><a href="/pages/abc8b5/" class="sidebar-link">日志结构文件系统</a></li><li><a href="/pages/b0802a/" class="sidebar-link">基于闪存的SSD</a></li><li><a href="/pages/812baf/" class="sidebar-link">数据完整性和保护</a></li><li><a href="/pages/5fb229/" class="sidebar-link">分布式系统</a></li><li><a href="/pages/627a30/" class="sidebar-link">网络文件系统</a></li><li><a href="/pages/acfea7/" class="sidebar-link">Andrew文件系统</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>分布式系统</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>云原生</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/develop/#开发" data-v-06225672>开发</a></li><li data-v-06225672><a href="/develop/#系统架构" data-v-06225672>系统架构</a></li><li data-v-06225672><a href="/develop/#操作系统" data-v-06225672>操作系统</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/unique-pure" target="_blank" title="作者" class="beLink" data-v-06225672>Pursuit</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-04-25</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">比例份额调度<!----></h1>  <div class="theme-vdoing-content content__default"><p>在本章中，我们将研究一种不同类型的调度器，称为比例份额（Proportional-share）调度器，有时也称为<font color="red">公平共享调度器</font>。比例共享基于一个简单的概念：调度器可能会尝试保证每个作业获得一定百分比的 CPU 时间，而不是针对周转时间或响应时间进行优化。</p> <p>比例份额调度有一个非常出色的早期例子是彩票调度（lottery scheduling），由 Waldspurger 和 Weihl 发现。其基本思想非常简单，每隔一段时间，就会举行一次彩票抽奖，来确定接下来该运行哪个进程。更频繁运行的进程则更有机会中奖。</p> <p>在处理细节前先抛出我们的关键问题：如何按比例共享CPU？我们如何设计一个调度器以按比例共享 CPU？这样做的关键机制是什么？它们的效果如何？</p> <h2 id="_1-基本概念-彩票代表份额"><a href="#_1-基本概念-彩票代表份额" class="header-anchor">#</a> 1 基本概念：彩票代表份额</h2> <p>彩票调度背后是一个非常基本的概念：<font color="red">彩票数</font>，代表了进程（或用户或其他）占有某个资源的份额。一个一个进程拥有的彩票数占总彩票数的百分比，就是它占有系统资源的份额。</p> <p>例如，有两个进程A和B，其中A有75张彩票，而B只有25张彩票。因此，我们希望A占有<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>75</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">75\%</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.8056em;vertical-align:-0.0556em;"></span><span class="mord">75%</span></span></span></span>的CPU，B占有<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>25</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">25\%</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.8056em;vertical-align:-0.0556em;"></span><span class="mord">25%</span></span></span></span>的CPU。</p> <p>彩票调度通过每隔一段时间（比如每个时间片）举行一次抽奖，以概率方式（而非确定方式）实现这一目标。举行抽奖很简单：调度器必须知道总共有多少张彩票（在我们的例子中，有 100 张彩票），调度器接下来随机抽取中奖彩票，是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>99</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0,99]</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">99</span><span class="mclose">]</span></span></span></span>的数字。假设 A 持有 0 到 74 号彩票，B 持有 75 到 99 号彩票，中奖彩票就决定了运行A或B。然后调度程序加载中奖进程的状态，并运行它。</p> <p>下面是彩票调度程序输出的中奖彩票和对应的调度结果:</p> <table><thead><tr><th style="text-align:center;">63</th> <th style="text-align:center;">85</th> <th style="text-align:center;">70</th> <th style="text-align:center;">39</th> <th style="text-align:center;">76</th> <th style="text-align:right;">17</th> <th style="text-align:center;">29</th> <th style="text-align:center;">41</th> <th style="text-align:center;">36</th> <th style="text-align:center;">39</th> <th style="text-align:right;">10</th> <th style="text-align:center;">99</th> <th style="text-align:center;">68</th> <th style="text-align:center;">83</th> <th style="text-align:center;">63</th> <th style="text-align:right;">62</th> <th style="text-align:center;">43</th> <th style="text-align:center;">0</th> <th style="text-align:center;">49</th> <th style="text-align:center;">49</th></tr></thead> <tbody><tr><td style="text-align:center;">A</td> <td style="text-align:center;"></td> <td style="text-align:center;">A</td> <td style="text-align:center;">A</td> <td style="text-align:center;"></td> <td style="text-align:right;">A</td> <td style="text-align:center;">A</td> <td style="text-align:center;">A</td> <td style="text-align:center;">A</td> <td style="text-align:center;">A</td> <td style="text-align:right;">A</td> <td style="text-align:center;"></td> <td style="text-align:center;">A</td> <td style="text-align:center;"></td> <td style="text-align:center;">A</td> <td style="text-align:right;">A</td> <td style="text-align:center;">A</td> <td style="text-align:center;">A</td> <td style="text-align:center;">A</td> <td style="text-align:center;">A</td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;">B</td> <td style="text-align:center;"></td> <td style="text-align:center;"></td> <td style="text-align:center;">B</td> <td style="text-align:right;"></td> <td style="text-align:center;"></td> <td style="text-align:center;"></td> <td style="text-align:center;"></td> <td style="text-align:center;"></td> <td style="text-align:right;"></td> <td style="text-align:center;">B</td> <td style="text-align:center;"></td> <td style="text-align:center;">B</td> <td style="text-align:center;"></td> <td style="text-align:right;"></td> <td style="text-align:center;"></td> <td style="text-align:center;"></td> <td style="text-align:center;"></td> <td style="text-align:center;"></td></tr></tbody></table> <p>从这个例子中我们可以看出，彩票调度的随机性导致了从概率上满足期望的比例，但不能确保。在上面的例子中，工作 B 运行了 20 个时间片中的 4 个，只是占了<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>20</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">20\%</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.8056em;vertical-align:-0.0556em;"></span><span class="mord">20%</span></span></span></span>，而不是期望的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>25</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">25\%</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.8056em;vertical-align:-0.0556em;"></span><span class="mord">25%</span></span></span></span>。但是，这两个工作运行得<font color="red">时间越长</font>，它们得到的 CPU 时间比例就会越<font color="red">接近期望</font>。</p> <p>随机性决策有优势也有劣势：</p> <ul><li>优势
<ol><li>避免最差情况</li> <li>轻量，不需要记录过多状态，传统公平调度需要记录进程的大量状态</li> <li>随机方法很快，决策也快</li></ol></li> <li>劣势
<ol><li>系统行为可能不可预测，因为它们不受先前状态或输入的直接影响，这可能导致一些进程等待时间过长，而另一些则过短。</li> <li>可能导致性能波动</li></ol></li></ul> <blockquote><center>TIP：使用彩票数代表份额</center> <p>彩票（和步幅）调度设计中最强大（也是基本）的机制之一就是彩票数机制。在这些示例中，彩票数用于表示进程对 CPU 的份额，但其应用范围可以更广泛。例如，在虚拟机管理程序虚拟内存管理的最新研究中，Waldspurger 展示了如何使用彩票数来表示客户操作系统的内存份额。因此，如果您需要一种机制来代表一定比例的所有权，这个概念可能就是……（等等）……彩票数。</p></blockquote> <h2 id="_2-彩票机制"><a href="#_2-彩票机制" class="header-anchor">#</a> 2 彩票机制</h2> <p>彩票调度还提供了许多机制，以不同的方式（有时是有用的方式）操纵彩票。一种机制是<font color="red">彩票货币（ticket currency）</font>。这种机制允许拥有一组彩票的用户在自己的工作中以任意货币分配彩票；然后系统会自动将所述货币转换为正确的全局彩票。</p> <p>例如，假设用户A和用户B都有100张彩票，A正在运行两个作业：A1和A2，然后用 A 的货币给它们每人 500 张彩票（总共 1000 张）。用户B正在运行一个作业，然后用B的货币给它分配10张彩票（总共10张）。系统将 A1 和 A2 的分配从 A 货币各 500 转换为全球货币各 50；同样，B1的10张票折算为100张票。然后在全球彩票货币（共 200 个）上进行抽签，以决定哪个工作运行。A1的具体计算方法是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><msub><mtext>Ticket</mtext><mrow><mi>A</mi><mn>1</mn></mrow></msub><mrow><msub><mtext>Ticket</mtext><mrow><mi>A</mi><mn>1</mn></mrow></msub><mo>+</mo><msub><mtext>Ticket</mtext><mrow><mi>A</mi><mn>2</mn></mrow></msub></mrow></mfrac><mo>×</mo><msub><mtext>Ticket</mtext><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">\frac{\text{Ticket}_{A1}}{\text{Ticket}_{A1}+\text{Ticket}_{A2}}\times \text{Ticket}_{A}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1.3417em;vertical-align:-0.4453em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8964em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Ticket</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1433em;"><span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Ticket</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1433em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.4103em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Ticket</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1433em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4453em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">Ticket</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，其他同理。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>User A

-&gt; 500 (A's ticket currency) to A1 -&gt; 50 (global currency)

-&gt; 500 (A's ticket currency) to A2 -&gt; 50 (global currency)

User B

-&gt; 10 (B's ticket currency) to B1 -&gt; 100 (global currency)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>另一个有用的机制是<font color="red">彩票转让（ticket transfer）</font>。通过转让，一个进程可以暂时将其彩票转让给另一个进程。这种能力在客户端/服务器设置中特别有用，其中客户端进程向服务器发送消息，要求服务器代表客户端执行一些工作。为了加快工作速度，客户端可以将彩票转让给服务器，并尝试最大化服务器的性能，同时处理客户端的请求。完成后，服务器将票据归还给客户端，一切如旧。</p> <p>最后，<font color="red">彩票通胀（ticket inflation）</font>机制有时也很有用。通过通货膨胀，进程可以暂时增加或减少其拥有的彩票数。当然，在进程相互不信任的竞争场景中，这是没有意义的；一个贪婪的进程可以给自己大量的彩票从而接管机器。但是，通胀可以应用于一组进程相互信任的环境中。在这种情况下，如果任何一个进程知道它需要更多的 CPU 时间，它可以增加自己的彩票数，作为向系统反映该需求的一种方式，而无需与任何其他进程进行通信。</p> <h2 id="_3-实现"><a href="#_3-实现" class="header-anchor">#</a> 3 实现</h2> <p>彩票调度最令人惊叹的地方可能就是其实施的简单性。你只需要一个好的随机数生成器来挑选中奖彩票，一个跟踪系统进程的数据结构（如列表），以及彩票总数。</p> <p>假设我们将进程保存在一个列表中。下面是一个由 A、B 和 C 三个进程组成的示例，每个进程都有一定数量的彩票数。</p> <p><img src="https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/ticket" alt="image-20240327215707333"></p> <p>为了做出调度决策，我们首先要从门票总数（400） 中随机抽取一个数字（中奖号码）。然后，我们只需遍历列表，用一个简单的计数器帮助我们找到中奖者。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># counter: used to track if we've found the winner yet</span>
counter <span class="token operator">=</span> <span class="token number">0</span>

<span class="token comment"># winner: use some call to a random number generator to get a value, between 0 and the total # of tickets</span>
winner <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> totaltickets<span class="token punctuation">)</span>

<span class="token comment"># current: use this to walk through the list of jobs</span>
current <span class="token operator">=</span> head

<span class="token comment"># loop until the sum of ticket values is &gt; the winner</span>
<span class="token keyword">while</span> current<span class="token punctuation">:</span>
    counter <span class="token operator">=</span> counter <span class="token operator">+</span> current<span class="token punctuation">.</span>tickets
    <span class="token keyword">if</span> counter <span class="token operator">&gt;</span> winner<span class="token punctuation">:</span>
        <span class="token keyword">break</span>  <span class="token comment"># found the winner</span>
    current <span class="token operator">=</span> current<span class="token punctuation">.</span><span class="token builtin">next</span>

<span class="token comment"># 'current' is the winner: schedule it...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>该代码从前往后遍历进程列表，将每个彩票值添加到计数器中，直到该值超过获胜者。一旦出现这种情况，当前列表进程就是中奖者。以中奖彩票为 300 的示例为例，会发生以下情况。首先，计数器增加到 100 以计算 A 的票；因为 100 小于 300，所以循环继续。然后计数器会更新为 150（B 的票），仍然少于 300，因此我们再次继续。最后，计数器更新为 400（明显大于 300），因此我们跳出循环，当前指向 C（中奖者）。</p> <p>要让这个过程更有效率，建议将列表项按照彩票数<font color="red">递减排序</font>。这个顺序并不会影响算法的正确性，但能保证用<font color="red">最小的迭代次数</font>找到需要的结点，尤其当<font color="red">大多</font>彩票被<font color="red">少数</font>进程掌握时。</p> <h2 id="_4-评估指标"><a href="#_4-评估指标" class="header-anchor">#</a> 4 评估指标</h2> <p>为了更容易理解动态彩票调度，我们现在对两个相互竞争的作业的完成时间进行简要研究，每个作业都有相同数量的彩票 (100) 和相同的运行时间 (R，我们将改变它) 。</p> <p>在这种情况下，我们希望每个作业大致在同一时间完成，但由于彩票调度的随机性，有时一个作业会先于另一个作业完成。为了量化这种差异，我们定义了一个简单的<font color="red">不公平指标（unfairness metric）</font> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span></span></span></span>，它就是第一个作业完成的时间除以第二个作业完成的时间。</p> <p>例如，如果 R = 10，并且第一个作业在 10 完成（第二个作业在 20 完成），则 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mo>=</mo><mfrac><mn>10</mn><mn>20</mn></mfrac><mo>=</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">U=\frac{10}{20}=0.5</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">20</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">10</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.5</span></span></span></span>。当两个作业几乎同时完成时，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span></span></span></span> 将非常接近 1。在这种情况下，这就是我们的目标：完全公平的调度程序将实现 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">U = 1</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>。</p> <p>下图描绘了在30次试验中，两个作业（R）的长度从1到1000不等时的平均不公平性。从图中可以看出，当工作时间不长时，平均不公平现象可能相当严重。只有当作业运行了大量的时间片时，彩票调度程序才能接近所需的结果。</p> <img src="https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/experiment-lottery-sheduling" alt="image-20240327222820993" style="zoom:50%;"> <h2 id="_5-如何分配彩票"><a href="#_5-如何分配彩票" class="header-anchor">#</a> 5 如何分配彩票</h2> <p>在彩票调度方面，我们尚未解决的一个问题是：如何为作业分配彩票？这是一个棘手的问题，因为系统如何运行当然在很大程度上取决于如何分配彩票。一种方法是假定用户最了解情况；在这种情况下，每个用户都会得到一定数量的门票，用户可以根据需要将门票分配给他们运行的任何作业。然而，这种解决方案不是解决方案：它并没有告诉你该怎么做。因此，在给定一系列工作的情况下，&quot;彩票分配问题 &quot;仍然悬而未决。</p> <h2 id="_6-步幅调度"><a href="#_6-步幅调度" class="header-anchor">#</a> 6 步幅调度</h2> <p>你可能还想知道：为什么要使用随机性呢？如上所述，虽然随机性可以为我们提供一个简单（且近似正确）的调度器，但它偶尔无法提供精确正确的比例，尤其是在短时间内。为此，Waldspurger 发明了一种确定性公平分配调度器—步幅调度器 。</p> <p>步幅调度也很简单，系统中每个作业都有一个步幅，这与它拥有的彩票数成反比。在上面的示例中，对于作业 A、B 和 C，分别有 100、50 和 250 张彩票，我们可以通过将某个较大的数字除以每个进程分配的彩票数量来计算每个作业的步幅。例如，如果我们用 10,000 除以每个彩票值，我们将获得 A、B 和 C 的步幅值：100、200 和 40。我们将此值称为每个进程的步幅；每次进程运行时，我们都会按其步幅增加它的计数器（称为其行程值），以跟踪其全局进度。</p> <p>然后，调度程序使用步幅和行程值来确定接下来应该运行哪个进程。基本思想很简单：在任何给定时间，选择迄今为止具有最低行程值的进程来运行；当您运行一个进程时，按其步幅增加其行程值。 Waldspurger 提供了伪代码实现：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>curr <span class="token operator">=</span> <span class="token function">remove_min</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// pick client with min pass</span>
<span class="token function">schedule</span><span class="token punctuation">(</span>curr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// run for quantum</span>
curr<span class="token operator">-&gt;</span>pass <span class="token operator">+=</span> curr<span class="token operator">-&gt;</span>stride<span class="token punctuation">;</span> <span class="token comment">// update pass using stride</span>
<span class="token function">insert</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> curr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// return curr to queue</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在我们的示例中，一开始有三个进程（A、B 和 C），它们的步幅分别为 100、200 和 40，所有进程的行程值最初都是 0。假设我们选择 A（任意选择；可以选择任何一个行程值同样低的进程）。A 运行后，在完成时间片后，我们将其行程值更新为 100。然后运行 B，将其行程值设置为 200。最后运行 C，其行程值递增到 40。此时，算法将选择最低的行程值，即 C的行程值，然后运行C，将其行程值更新为 80（C 的步幅为 40）。然后 C 将再次运行（仍然是最低的行程值），将其行程值提升至 120。A 现在运行，将其行程值更新为 200（现在等于 B 的行程值）。然后 C 再运行两次，将其行程值更新为 160，然后是 200。此时，所有行程值再次相等，这个过程将无限重复。下表跟踪了调度器随时间变化的行为。</p> <table><thead><tr><th style="text-align:center;">Pass(A)</th> <th style="text-align:center;">Pass(B)</th> <th style="text-align:center;">Pass(C)</th> <th style="text-align:center;">Who Runs?</th></tr></thead> <tbody><tr><td style="text-align:center;">0</td> <td style="text-align:center;">0</td> <td style="text-align:center;">0</td> <td style="text-align:center;">A</td></tr> <tr><td style="text-align:center;">100</td> <td style="text-align:center;">0</td> <td style="text-align:center;">0</td> <td style="text-align:center;">B</td></tr> <tr><td style="text-align:center;">100</td> <td style="text-align:center;">200</td> <td style="text-align:center;">0</td> <td style="text-align:center;">C</td></tr> <tr><td style="text-align:center;">100</td> <td style="text-align:center;">200</td> <td style="text-align:center;">40</td> <td style="text-align:center;">C</td></tr> <tr><td style="text-align:center;">100</td> <td style="text-align:center;">200</td> <td style="text-align:center;">80</td> <td style="text-align:center;">C</td></tr> <tr><td style="text-align:center;">100</td> <td style="text-align:center;">200</td> <td style="text-align:center;">120</td> <td style="text-align:center;">A</td></tr> <tr><td style="text-align:center;">200</td> <td style="text-align:center;">200</td> <td style="text-align:center;">120</td> <td style="text-align:center;">C</td></tr> <tr><td style="text-align:center;">200</td> <td style="text-align:center;">200</td> <td style="text-align:center;">160</td> <td style="text-align:center;">C</td></tr> <tr><td style="text-align:center;">200</td> <td style="text-align:center;">200</td> <td style="text-align:center;">200</td> <td style="text-align:center;">...</td></tr></tbody></table> <p>从上表可以看出，C运行了5次，A2次，B只有一次，正好与它们的彩票值 250、100 和 50 成比例。彩票调度是随着时间的推移概率性地实现比例的，而步幅调度则是在每个调度周期结束时精确地实现比例。</p> <p>所以你可能想知道：跨步调度这么精准，为什么还要使用彩票调度呢？嗯，彩票调度有一个步幅调度没有的好特性：没有全局状态。想象一下，在上面的跨步调度示例中，有一个新作业进入；它的行程值应该是多少？应该设置为0吗？如果是的话，就会独占CPU。对于彩票调度，每个进程没有全局状态；我们只需添加一个新进程及其拥有的任何彩票，更新单个全局变量以跟踪我们总共拥有多少彩票，然后从那里开始。通过这种方式，彩票以合理的方式合并新进程更加容易。</p> <h2 id="_7-linux完全公平调度器-cfs"><a href="#_7-linux完全公平调度器-cfs" class="header-anchor">#</a> 7 Linux完全公平调度器（CFS）</h2> <p>尽管在公平份额调度方面已有早期工作，但当前的Linux方法以另一种方式实现了类似的目标。名为完全公平调度器（或CFS）的调度器实施了公平份额调度，但是以高效且可扩展的方式进行。</p> <p>为了实现其效率目标，CFS通过其固有设计和对任务非常适合的数据结构巧妙地使用极少时间做出调度决策。最近研究表明，调度器效率非常重要；具体而言，在对谷歌数据中心进行研究时，Kanev等人发现，即使经过积极优化，调度仍然占用整个数据中心约5%的CPU时间。因此，尽可能减少开销是现代调度程序架构的一个关键目标。</p> <h3 id="_7-1-基本操作"><a href="#_7-1-基本操作" class="header-anchor">#</a> 7.1 基本操作</h3> <p>大多数调度程序都基于固定时间片的概念，而 CFS 的运行方式则有些不同。它的目标很简单：将 CPU 公平地平均分配给所有竞争进程。它通过一种简单的基于计数的技术来实现这一目标，这种技术被称为<font color="red">虚拟运行时间（vruntime）</font>。</p> <p>每个进程运行时，都会累积<code>vruntime</code>。在最基本的情况下，每个进程的 <code>vruntime</code> 都以相同的速率增长，与物理（实际）时间成比例。在进行调度决策时，CFS 会选择 <code>vruntime</code> 最低的进程作为下一个运行进程。</p> <p>那这就提出了一个问题：调度器怎么知道何时停止正在运行的进程，并运行下一个进程呢？这里矛盾就很明显：如果 CFS 切换过于频繁，公平性就会提高，因为 CFS 将确保每个进程即使在极小的时间窗口内也能获得其 CPU 份额，但代价是性能降低（上下文切换过多）；如果 CFS 切换频率降低，性能就会提高（上下文切换减少），但代价是近期公平性降低。</p> <p>CFS通过各种控制参数来管理这种矛盾。第一个是<code>sched_latency</code>（调度延迟），CFS使用该值来确定一个进程在考虑切换之前应运行多长时间（以动态方式有效确定其时间片）。典型的<code>sched_latency</code>值为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>48</mn></mrow><annotation encoding="application/x-tex">48</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">48</span></span></span></span>（毫秒），CFS 将该值除以 CPU 上运行的进程数（n），以确定进程的时间片，从而确保在这段时间内，CFS 完全公平。</p> <p>例如，如果这有<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">n=4</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span></span></span></span>的进程在运行，CFS将<code>sched_latency</code>的值除以<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>得出每个进程的时间片为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12</mn><mtext>ms</mtext></mrow><annotation encoding="application/x-tex">12\text{ms}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">12</span><span class="mord text"><span class="mord">ms</span></span></span></span></span>。然后，CFS 会调度第一个作业并运行它，直到用完 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12</mn><mtext>ms</mtext></mrow><annotation encoding="application/x-tex">12\text{ms}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">12</span><span class="mord text"><span class="mord">ms</span></span></span></span></span> 的（虚拟）运行时间，然后检查是否有 <code>vruntime</code> 更低的作业可替代运行。在这种情况下，如果有，CFS 就会切换到其他三个作业中的一个，依此类推。下图展示了这样一个例子：四个作业（A、B、C、D）以这种方式各运行两个时间片；其中两个作业（C、D）完成后，只剩下两个作业，然后它们以循环方式各运行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12</mn><mtext>ms</mtext></mrow><annotation encoding="application/x-tex">12\text{ms}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">12</span><span class="mord text"><span class="mord">ms</span></span></span></span></span>。</p> <p><img src="https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/CFS-Simple-Example" alt="image-20240328093030185"></p> <p>但如果有 &quot;太多 &quot;进程在运行呢？这会不会导致时间片太小，从而导致太多的上下文切换？答案是肯定的。</p> <p>为了解决这个问题，CFS增加了另一个参数<code>min_granularity</code>，通常设置为 6 ms。CFS绝不会设置进程的时间片小于值，确保不会在调度开销上花费太多时间。</p> <p>例如，这有10个进程正在运行，我们原来的计算会用<code>sched_latency</code>除以<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn></mrow><annotation encoding="application/x-tex">10</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">10</span></span></span></span>得出进程时间片（结果为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4.8</mn><mtext>ms</mtext></mrow><annotation encoding="application/x-tex">4.8\text{ms}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4.8</span><span class="mord text"><span class="mord">ms</span></span></span></span></span>）。但因为<code>min_granularity</code>，CFS会每个进程的时间片设置为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>6</mn><mtext>ms</mtext></mrow><annotation encoding="application/x-tex">6\text{ms}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">6</span><span class="mord text"><span class="mord">ms</span></span></span></span></span>。虽然 CFS 的公平性不会超过在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4.8</mn><mtext>ms</mtext></mrow><annotation encoding="application/x-tex">4.8\text{ms}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4.8</span><span class="mord text"><span class="mord">ms</span></span></span></span></span> 的目标调度延迟（<code>sched_latency</code>），但它将接近目标值，同时仍能实现较高的 CPU 效率。</p> <p>需要的注意是，CFS 使用的是周期性定时器中断，这意味着它只能在固定的时间间隔内做出决定。该中断会频繁响起（例如，每 1 ms响一次），让 CFS 有机会唤醒并确定当前作业是否已运行结束。如果作业的时间片不是定时器中断间隔的整数倍，也没关系；CFS 会精确跟踪 <code>vruntime</code>，这意味着从长远来看，它最终会接近理想的 CPU 共享状态。</p> <h3 id="_7-2-权重-优先级"><a href="#_7-2-权重-优先级" class="header-anchor">#</a> 7.2 权重（优先级）</h3> <p>CFS 还可以控制进程优先级，使用户或管理员能够为某些进程提供更高的 CPU 份额。它不是通过彩票来实现这一点，而是通过经典 UNIX 机制—进程的<code>nice</code>级别的来实现这一点。对于进程，<code>nice</code> 参数可以设置为 -20 到 +19 之间的任意值，默认值为 0。正的 Nice 值意味着较低的优先级，负值意味着较高的优先级；<s>当你太好的时候，你就不会得到那么多（安排）关注，唉。</s></p> <p>CFS将每个进程的<code>nice</code>值映射到一个权重，如下所示：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> prio_to_weight<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token comment">/* -20 */</span> <span class="token number">88761</span><span class="token punctuation">,</span> <span class="token number">71755</span><span class="token punctuation">,</span> <span class="token number">56483</span><span class="token punctuation">,</span> <span class="token number">46273</span><span class="token punctuation">,</span> <span class="token number">36291</span><span class="token punctuation">,</span>
    <span class="token comment">/* -15 */</span> <span class="token number">29154</span><span class="token punctuation">,</span> <span class="token number">23254</span><span class="token punctuation">,</span> <span class="token number">18705</span><span class="token punctuation">,</span> <span class="token number">14949</span><span class="token punctuation">,</span> <span class="token number">11916</span><span class="token punctuation">,</span>
    <span class="token comment">/* -10 */</span> <span class="token number">9548</span><span class="token punctuation">,</span> <span class="token number">7620</span><span class="token punctuation">,</span> <span class="token number">6100</span><span class="token punctuation">,</span> <span class="token number">4904</span><span class="token punctuation">,</span> <span class="token number">3906</span><span class="token punctuation">,</span>
    <span class="token comment">/* -5 */</span> <span class="token number">3121</span><span class="token punctuation">,</span> <span class="token number">2501</span><span class="token punctuation">,</span> <span class="token number">1991</span><span class="token punctuation">,</span> <span class="token number">1586</span><span class="token punctuation">,</span> <span class="token number">1277</span><span class="token punctuation">,</span>
    <span class="token comment">/* 0 */</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">820</span><span class="token punctuation">,</span> <span class="token number">655</span><span class="token punctuation">,</span> <span class="token number">526</span><span class="token punctuation">,</span> <span class="token number">423</span><span class="token punctuation">,</span>
    <span class="token comment">/* 5 */</span> <span class="token number">335</span><span class="token punctuation">,</span> <span class="token number">272</span><span class="token punctuation">,</span> <span class="token number">215</span><span class="token punctuation">,</span> <span class="token number">172</span><span class="token punctuation">,</span> <span class="token number">137</span><span class="token punctuation">,</span>
    <span class="token comment">/* 10 */</span> <span class="token number">110</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">56</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">,</span>
    <span class="token comment">/* 15 */</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>有了这些权重，我们就可以计算每个进程的有效时间片（就像我们之前所做的），但现在要考虑它们的优先级差异。计算公式如下：</p> <p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mtext>time_slice</mtext><mi>k</mi></msub><mo>=</mo><mfrac><msub><mtext>weight</mtext><mi>k</mi></msub><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></munderover><msub><mtext>weight</mtext><mi>i</mi></msub></mrow></mfrac><mo>⋅</mo><mtext>sched_latency</mtext></mrow><annotation encoding="application/x-tex">\text{time\_slice}_k= \frac {\text{weight}_k}{\sum _ {i=0}^ {n-1}\text{weight}_ {i}} \cdot \text{sched\_latency}
</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1.0541em;vertical-align:-0.3597em;"></span><span class="mord"><span class="mord text"><span class="mord">time_slice</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1264em;"><span style="top:-2.3403em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3597em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.5152em;vertical-align:-1.1437em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.156em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord text"><span class="mord">weight</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2175em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord text"><span class="mord">weight</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.242em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1437em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"></span><span class="mord text"><span class="mord">sched_latency</span></span></span></span></span></span></p> <p>让我们举个例子来看看它是如何工作的。假定有两个工作，A 和 B。A 因为是我们最宝贵的工作，所以优先级较高，<code>nice</code>值为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">-5</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">−</span><span class="mord">5</span></span></span></span>；B 因为我们不喜欢它，所以优先级为默认值（<code>nice</code>值等于 0）。这意味着<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext>weight</mtext><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">\text{weight}_A</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.9386em;vertical-align:-0.2441em;"></span><span class="mord"><span class="mord text"><span class="mord">weight</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2342em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span></span></span></span>（来自权重表）为 3121，而<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext>weight</mtext><mi>B</mi></msub></mrow><annotation encoding="application/x-tex">\text{weight}_B</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.9386em;vertical-align:-0.2441em;"></span><span class="mord"><span class="mord text"><span class="mord">weight</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2342em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span></span></span></span> 为 1024。如果计算每个作业的时间片，就会发现 A 的时间片约为<code>sched_latency</code>的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>3</mn><mn>4</mn></mfrac></mrow><annotation encoding="application/x-tex">\frac{3}{4}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>（即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>36</mn><mtext>ms</mtext></mrow><annotation encoding="application/x-tex">36\text{ms}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">36</span><span class="mord text"><span class="mord">ms</span></span></span></span></span>），而 B 约为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><mn>4</mn></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{4}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>（即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12</mn><mtext>ms</mtext></mrow><annotation encoding="application/x-tex">12\text{ms}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">12</span><span class="mord text"><span class="mord">ms</span></span></span></span></span>）。</p> <p>除了泛化时间片计算外，CFS计算<code>vruntime</code>的方式也必须进行调整，以下是新公式：</p> <p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mtext>vruntime</mtext><mi>i</mi></msub><mo>=</mo><msub><mtext>vruntime</mtext><mi>i</mi></msub><mo>+</mo><mfrac><msub><mtext>weight</mtext><mn>0</mn></msub><msub><mtext>weight</mtext><mi>i</mi></msub></mfrac><mo>⋅</mo><msub><mtext>runtime</mtext><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\text{vruntime}_i=\text{vruntime}_i+\frac{\text{weight}_0}{\text{weight}_i}\cdot \text{runtime}_i
</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.8179em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">vruntime</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8179em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">vruntime</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.3016em;vertical-align:-0.9301em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord text"><span class="mord">weight</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2175em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord text"><span class="mord">weight</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9301em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8179em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">runtime</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p> <p>它根据进程<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span>累积的实际运行时间（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext>runtime</mtext><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\text{runtime}_i</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.8179em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">runtime</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>），并与进程的权重成反比。在我们的运行示例中，A 的 <code>vruntime</code> 累积速度是 B 的三分之一。</p> <p>构建上述权重表的一个巧妙之处在于，当 <code>nice</code> 值的差异恒定时，该表保留了 CPU 比例。例如，如果进程 A 的 <code>nice</code> 值为 5（不是 -5），进程 B 的 <code>nice</code> 值为 10（不是 0），则 CFS 将以与之前完全相同的方式调度它们。</p> <h3 id="_7-3-使用红黑树"><a href="#_7-3-使用红黑树" class="header-anchor">#</a> 7.3 使用红黑树</h3> <p>如上所述，CFS 的一个重点是效率。对于调度器来说，效率有很多方面，但其中一个方面非常简单：当调度器需要查找下一个要运行的作业时，它应该尽可能快地找到该作业。简单的数据结构（如列表）不具扩展性：现代系统有时由上千个进程组成，因此每隔几毫秒搜索一次长列表会非常浪费。</p> <p>CFS 通过将进程保留在红黑树上来解决这个问题。红黑树是多种类型的平衡树之一；与简单的二叉树（在最糟糕的插入模式下，它的性能会退化到类似于列表）不同，平衡树需要做一些额外的工作来保持较低的深度，从而确保操作在时间上是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>log</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\log</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span></span></span></span>（而非线性）的。</p> <p>CFS 不会将所有进程都保存在此结构中；相反，只有正在运行（或可运行）的进程才会保存在此结构中。如果某个进程进入休眠状态（例如，等待 I/O 完成或等待网络数据包到达），它就会从进程树中删除，并在其他地方跟踪。</p> <p>让我们看一个例子来更清楚地说明这一点。假设有十个作业，它们的 <code>vruntime</code> 值分别为：1、5、9、10、14、18、17、21、22 和 24。如果我们将这些作业保存在一个有序列表中，那么查找下一个要运行的作业就很简单了：只需删除第一个元素即可。但是，如果将该作业按顺序放回列表中，我们必须扫描这个列表，寻找正确的位置插入，这是一个 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> 运算。任何搜索的效率也很低，平均也需要线性时间。</p> <p>而在红黑树上保持相同的值可以提高大多数操作的效率，如下图所示。</p> <img src="https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/CFS-Red-Black-Tree.png" alt="image-20240328190846235" style="zoom:50%;"> <p>进程在树中按 <code>vruntime</code> 排序，大多数操作（如插入和删除）的时间都是对数级别，即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>。当 n 越来越大，对数效率明显高于线性效率。</p> <h3 id="_7-4-处理i-o和休眠进程"><a href="#_7-4-处理i-o和休眠进程" class="header-anchor">#</a> 7.4 处理I/O和休眠进程</h3> <p>对于已经进入休眠状态很长一段时间的作业来说，选择下一个运行的最低 <code>vruntime</code> 会出现一个问题。例如有两个进程 A 和 B，其中一个 (A) 连续运行，另一个 (B) 已经进入休眠状态很长一段时间（例如 10 秒）。当 B 醒来时，它的 <code>vruntime</code> 将落后 A 10 秒，因此（如果我们不小心的话），B 现在将在接下来的 10 秒内独占 CPU，同时赶上 A，这实际上会让A饥饿。</p> <p>CFS 通过在作业唤醒时更改其 <code>vruntime</code>来处理这种情况。具体来说，CFS 会将该作业的 <code>vruntime</code> 设置为在树中找到的最小值（记住，树中只包含正在运行的作业）。通过这种方式，CFS 避免了饥饿，但也并非没有代价：短时间睡眠的作业往往无法获得公平的 CPU 份额。</p> <h2 id="_8-总结"><a href="#_8-总结" class="header-anchor">#</a> 8 总结</h2> <p>我们介绍了比例份额调度的概念，并简要讨论了三种方法：彩票调度、步幅调度和 Linux 的完全公平调度器（CFS）。彩票调度巧妙地利用随机性来实现比例份额，而步幅调度则是确定性地实现比例份额。CFS 是本章讨论的唯一一种 &quot;真正的 &quot;调度程序，有点像带有动态时间片的加权循环调度程序，但其设计可在负载情况下进行扩展并表现良好；据我们所知，它是目前使用最广泛的公平分配调度程序。</p> <p>任何调度器都不是万能的，公平共享调度器也有自己的问题。其中一个问题是，这种方法与 I/O 并不十分匹配；如上所述，偶尔执行 I/O 的作业可能无法获得公平分配的 CPU。另一个问题是，它们没有解决彩票或优先级分配的难题，也就是说，你怎么知道应该给你的浏览器分配多少彩票，或者给你的文本编辑器设置<code>nice</code>的值呢？其他通用调度程序（如我们之前讨论过的 MLFQ 和其他类似的 Linux 调度程序）会自动处理这些问题，因此可能更容易部署。</p> <p>好消息是，在许多领域中，这些问题并不是主要问题，比例份额调度器的使用效果很好。例如，在虚拟化数据中心（或云计算）中，你可能希望将四分之一的 CPU 周期分配给 <code>Windows VM</code>，其余的分配给基本的 Linux 安装，按比例份额可以简单而有效地做到这一点。这个想法还可以扩展到其他地方。</p></div></div> <div class="page-slot page-slot-bottom"><div class="donation">
      <button>打赏</button>
      <div class="main">
        <div class="pic">
          <img src="https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/wechatpay.jpeg" alt="微信">
          <img src="https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/zhifubaopay.jpeg" alt="支付宝">
        </div>
      </div>  
    </div></div> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=OS" title="标签">#OS</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/05/11, 20:33:38</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/a1ad96/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">多级反馈队列</div></a> <a href="/pages/326999/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">多CPU调度</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/a1ad96/" class="prev">多级反馈队列</a></span> <span class="next"><a href="/pages/326999/">多CPU调度</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/44470f/"><div>
            【论文阅读笔记】DeepCAD: A Deep Generative Network for Computer-Aided Design Models
            <!----></div></a> <span class="date">07-08</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/e7f6f5/"><div>
            【论文阅读笔记】Attention Is All You Need
            <!----></div></a> <span class="date">07-07</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/e34cdb/"><div>
            Shell 23道例题实战
            <!----></div></a> <span class="date">06-09</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:unique.hzf@gmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/unique-pure" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://pursuit.blog.csdn.net/" title="My CSDN" target="_blank" class="iconfont icon-csdn"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2020-2024
    <span>Pursuit | <a href="https://github.com/unique-pure/my-vdoing-blog-template/blob/main/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><!----><div></div><WebInfo></WebInfo><PageInfo></PageInfo><div></div></div></div>
    <script src="/assets/js/app.bf22d313.js" defer></script><script src="/assets/js/4.71a85121.js" defer></script><script src="/assets/js/1.4a1189e9.js" defer></script><script src="/assets/js/3.bca043f9.js" defer></script><script src="/assets/js/109.b30c73e0.js" defer></script><script src="/assets/js/20.bc1029fc.js" defer></script>
  </body>
</html>
