<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>并发bug | Pursuit&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="随便写写">
    <meta name="keywords" content="python,Go,C++,git,github,markdown,database,mysql,redis">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.a3990aec.css" as="style"><link rel="preload" href="/assets/js/app.f72d119d.js" as="script"><link rel="preload" href="/assets/js/4.71a85121.js" as="script"><link rel="preload" href="/assets/js/1.4a1189e9.js" as="script"><link rel="preload" href="/assets/js/3.bca043f9.js" as="script"><link rel="preload" href="/assets/js/124.51fabad6.js" as="script"><link rel="preload" href="/assets/js/20.bc1029fc.js" as="script"><link rel="prefetch" href="/assets/js/10.ce2d8b4d.js"><link rel="prefetch" href="/assets/js/100.0cc215fc.js"><link rel="prefetch" href="/assets/js/101.213bbbd8.js"><link rel="prefetch" href="/assets/js/102.51e5f1bc.js"><link rel="prefetch" href="/assets/js/103.486f41f8.js"><link rel="prefetch" href="/assets/js/104.df5e8b73.js"><link rel="prefetch" href="/assets/js/105.dfffb699.js"><link rel="prefetch" href="/assets/js/106.f0159e6c.js"><link rel="prefetch" href="/assets/js/107.a4d91205.js"><link rel="prefetch" href="/assets/js/108.35688da1.js"><link rel="prefetch" href="/assets/js/109.8a808c81.js"><link rel="prefetch" href="/assets/js/11.87208a0c.js"><link rel="prefetch" href="/assets/js/110.b75fd268.js"><link rel="prefetch" href="/assets/js/111.596c7b52.js"><link rel="prefetch" href="/assets/js/112.de906566.js"><link rel="prefetch" href="/assets/js/113.9489bdc0.js"><link rel="prefetch" href="/assets/js/114.b784904b.js"><link rel="prefetch" href="/assets/js/115.10a0497d.js"><link rel="prefetch" href="/assets/js/116.0e94df25.js"><link rel="prefetch" href="/assets/js/117.962946da.js"><link rel="prefetch" href="/assets/js/118.c7f79ba8.js"><link rel="prefetch" href="/assets/js/119.78992cbe.js"><link rel="prefetch" href="/assets/js/12.7f5cceef.js"><link rel="prefetch" href="/assets/js/120.06c64707.js"><link rel="prefetch" href="/assets/js/121.c8f002b2.js"><link rel="prefetch" href="/assets/js/122.17aa32ff.js"><link rel="prefetch" href="/assets/js/123.fbc179b5.js"><link rel="prefetch" href="/assets/js/125.16c09521.js"><link rel="prefetch" href="/assets/js/126.fdaef09a.js"><link rel="prefetch" href="/assets/js/127.1eedff9d.js"><link rel="prefetch" href="/assets/js/128.a7c3a7d6.js"><link rel="prefetch" href="/assets/js/129.d754cfdb.js"><link rel="prefetch" href="/assets/js/13.f2cea533.js"><link rel="prefetch" href="/assets/js/130.e727c642.js"><link rel="prefetch" href="/assets/js/131.7c15875a.js"><link rel="prefetch" href="/assets/js/132.df56e455.js"><link rel="prefetch" href="/assets/js/133.d8918b62.js"><link rel="prefetch" href="/assets/js/134.b96c2cab.js"><link rel="prefetch" href="/assets/js/135.0c04fca3.js"><link rel="prefetch" href="/assets/js/136.3dc74606.js"><link rel="prefetch" href="/assets/js/137.a5792eaa.js"><link rel="prefetch" href="/assets/js/138.7a660261.js"><link rel="prefetch" href="/assets/js/139.e0e367ec.js"><link rel="prefetch" href="/assets/js/14.f8459573.js"><link rel="prefetch" href="/assets/js/140.a24b972e.js"><link rel="prefetch" href="/assets/js/141.e72ae940.js"><link rel="prefetch" href="/assets/js/142.687d3ba6.js"><link rel="prefetch" href="/assets/js/143.0d698e0e.js"><link rel="prefetch" href="/assets/js/144.70e24ef3.js"><link rel="prefetch" href="/assets/js/145.08e43037.js"><link rel="prefetch" href="/assets/js/146.e98a79a6.js"><link rel="prefetch" href="/assets/js/147.a42a364c.js"><link rel="prefetch" href="/assets/js/148.572d4f7c.js"><link rel="prefetch" href="/assets/js/149.049c6c6d.js"><link rel="prefetch" href="/assets/js/15.06cd6cc8.js"><link rel="prefetch" href="/assets/js/150.06c315db.js"><link rel="prefetch" href="/assets/js/151.37998079.js"><link rel="prefetch" href="/assets/js/152.38c5f087.js"><link rel="prefetch" href="/assets/js/153.6f3d748e.js"><link rel="prefetch" href="/assets/js/154.3c16da77.js"><link rel="prefetch" href="/assets/js/155.e195340c.js"><link rel="prefetch" href="/assets/js/156.56e2a446.js"><link rel="prefetch" href="/assets/js/16.33942615.js"><link rel="prefetch" href="/assets/js/17.da2e0126.js"><link rel="prefetch" href="/assets/js/18.a39b8ae2.js"><link rel="prefetch" href="/assets/js/19.1760f287.js"><link rel="prefetch" href="/assets/js/2.8e76b5b7.js"><link rel="prefetch" href="/assets/js/21.4b161474.js"><link rel="prefetch" href="/assets/js/22.69d29451.js"><link rel="prefetch" href="/assets/js/23.2a87052f.js"><link rel="prefetch" href="/assets/js/24.6beeaf9b.js"><link rel="prefetch" href="/assets/js/25.e9d4e312.js"><link rel="prefetch" href="/assets/js/26.c128f1d5.js"><link rel="prefetch" href="/assets/js/27.2bab9253.js"><link rel="prefetch" href="/assets/js/28.0b0ea581.js"><link rel="prefetch" href="/assets/js/29.71a2a1e9.js"><link rel="prefetch" href="/assets/js/30.11fd1987.js"><link rel="prefetch" href="/assets/js/31.92abb231.js"><link rel="prefetch" href="/assets/js/32.27d7c672.js"><link rel="prefetch" href="/assets/js/33.9f002fe8.js"><link rel="prefetch" href="/assets/js/34.39abd7b3.js"><link rel="prefetch" href="/assets/js/35.a54492ae.js"><link rel="prefetch" href="/assets/js/36.1b3ef370.js"><link rel="prefetch" href="/assets/js/37.3dda47b6.js"><link rel="prefetch" href="/assets/js/38.3dc3656a.js"><link rel="prefetch" href="/assets/js/39.78160c0e.js"><link rel="prefetch" href="/assets/js/40.382841f8.js"><link rel="prefetch" href="/assets/js/41.885f2f51.js"><link rel="prefetch" href="/assets/js/42.a794deca.js"><link rel="prefetch" href="/assets/js/43.bd06b1c5.js"><link rel="prefetch" href="/assets/js/44.c5b9fce0.js"><link rel="prefetch" href="/assets/js/45.8e169e05.js"><link rel="prefetch" href="/assets/js/46.907fb663.js"><link rel="prefetch" href="/assets/js/47.b494d092.js"><link rel="prefetch" href="/assets/js/48.7c4206ed.js"><link rel="prefetch" href="/assets/js/49.16bab940.js"><link rel="prefetch" href="/assets/js/5.780a742d.js"><link rel="prefetch" href="/assets/js/50.bf2afa43.js"><link rel="prefetch" href="/assets/js/51.0a1e84c2.js"><link rel="prefetch" href="/assets/js/52.59a39ef7.js"><link rel="prefetch" href="/assets/js/53.572697e9.js"><link rel="prefetch" href="/assets/js/54.fc2487d6.js"><link rel="prefetch" href="/assets/js/55.3db8ca64.js"><link rel="prefetch" href="/assets/js/56.da82f3ee.js"><link rel="prefetch" href="/assets/js/57.65140fab.js"><link rel="prefetch" href="/assets/js/58.038a1801.js"><link rel="prefetch" href="/assets/js/59.0a608087.js"><link rel="prefetch" href="/assets/js/6.6c206683.js"><link rel="prefetch" href="/assets/js/60.51f050d8.js"><link rel="prefetch" href="/assets/js/61.6abcae6d.js"><link rel="prefetch" href="/assets/js/62.040dca65.js"><link rel="prefetch" href="/assets/js/63.c80d3177.js"><link rel="prefetch" href="/assets/js/64.78dead08.js"><link rel="prefetch" href="/assets/js/65.e2ea8e5b.js"><link rel="prefetch" href="/assets/js/66.e1659233.js"><link rel="prefetch" href="/assets/js/67.7ae0702b.js"><link rel="prefetch" href="/assets/js/68.32bb7b03.js"><link rel="prefetch" href="/assets/js/69.e6b7a470.js"><link rel="prefetch" href="/assets/js/7.03420b55.js"><link rel="prefetch" href="/assets/js/70.a13ff72d.js"><link rel="prefetch" href="/assets/js/71.54febd22.js"><link rel="prefetch" href="/assets/js/72.65a42cfa.js"><link rel="prefetch" href="/assets/js/73.0972aa8d.js"><link rel="prefetch" href="/assets/js/74.d3464007.js"><link rel="prefetch" href="/assets/js/75.36a79d28.js"><link rel="prefetch" href="/assets/js/76.06281305.js"><link rel="prefetch" href="/assets/js/77.f8ad834e.js"><link rel="prefetch" href="/assets/js/78.21c774d1.js"><link rel="prefetch" href="/assets/js/79.dafe6715.js"><link rel="prefetch" href="/assets/js/80.ecd920cb.js"><link rel="prefetch" href="/assets/js/81.a749ccb4.js"><link rel="prefetch" href="/assets/js/82.8ac6ee9b.js"><link rel="prefetch" href="/assets/js/83.2af4873d.js"><link rel="prefetch" href="/assets/js/84.9ed04afc.js"><link rel="prefetch" href="/assets/js/85.36e61314.js"><link rel="prefetch" href="/assets/js/86.12f238fd.js"><link rel="prefetch" href="/assets/js/87.da9c1c69.js"><link rel="prefetch" href="/assets/js/88.401bc0ca.js"><link rel="prefetch" href="/assets/js/89.c6934f24.js"><link rel="prefetch" href="/assets/js/90.6433c059.js"><link rel="prefetch" href="/assets/js/91.015ed9e9.js"><link rel="prefetch" href="/assets/js/92.5c42bf0b.js"><link rel="prefetch" href="/assets/js/93.c058db1e.js"><link rel="prefetch" href="/assets/js/94.566967b2.js"><link rel="prefetch" href="/assets/js/95.f8252936.js"><link rel="prefetch" href="/assets/js/96.318f437f.js"><link rel="prefetch" href="/assets/js/97.a8db2e55.js"><link rel="prefetch" href="/assets/js/98.252090ac.js"><link rel="prefetch" href="/assets/js/99.54c9f8bf.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.caeb3b49.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a3990aec.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpeg" alt="Pursuit's blog" class="logo"> <span class="site-name can-hide">Pursuit's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发" class="dropdown-title"><a href="/develop/" class="link-title">开发</a> <span class="title" style="display:none;">开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/develop/language/" class="nav-link">编程语言</a></li><li class="dropdown-item"><!----> <a href="/develop/framework/" class="nav-link">开发框架</a></li><li class="dropdown-item"><!----> <a href="/develop/algorithm/" class="nav-link">数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/develop/storage/" class="nav-link">数据存储</a></li><li class="dropdown-item"><!----> <a href="/develop/system/" class="nav-link">系统架构</a></li><li class="dropdown-item"><!----> <a href="/develop/network/" class="nav-link">计算机网络</a></li><li class="dropdown-item"><!----> <a href="/develop/cloud/" class="nav-link">云原生</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><a href="/tool/" class="link-title">工具</a> <span class="title" style="display:none;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tool/vcs/" class="nav-link">版本控制</a></li><li class="dropdown-item"><!----> <a href="/tool/network/" class="nav-link">网络工具</a></li><li class="dropdown-item"><!----> <a href="/tool/develop/" class="nav-link">开发工具</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><a href="/note/" class="link-title">学习笔记</a> <span class="title" style="display:none;">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/paper/" class="nav-link">学术搬砖</a></li><li class="dropdown-item"><!----> <a href="/note/project/" class="nav-link">实践项目</a></li><li class="dropdown-item"><!----> <a href="/note/lecture/" class="nav-link">讲座研讨</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="生活杂谈" class="dropdown-title"><a href="/life/" class="link-title">生活杂谈</a> <span class="title" style="display:none;">生活杂谈</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/life/year/" class="nav-link">随写编年</a></li><li class="dropdown-item"><!----> <a href="/life/youth/" class="nav-link">追忆青春</a></li><li class="dropdown-item"><!----> <a href="/life/travel/" class="nav-link">旅行日记</a></li><li class="dropdown-item"><!----> <a href="/life/art/" class="nav-link">文艺时光</a></li><li class="dropdown-item"><!----> <a href="/life/cook/" class="nav-link">烹调分享</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="资源收藏" class="dropdown-title"><a href="/resource/" class="link-title">资源收藏</a> <span class="title" style="display:none;">资源收藏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/resource/website/" class="nav-link">实用网站</a></li><li class="dropdown-item"><!----> <a href="/resource/project/" class="nav-link">优秀项目</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/more/interview/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/more/tip/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/more/blog/" class="nav-link">博客相关</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friend/" class="nav-link">友链</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/unique-pure/my-vdoing-blog-template" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar.jpeg"> <div class="blogger-info"><h3>Pursuit</h3> <span>但行好事，莫问前程</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发" class="dropdown-title"><a href="/develop/" class="link-title">开发</a> <span class="title" style="display:none;">开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/develop/language/" class="nav-link">编程语言</a></li><li class="dropdown-item"><!----> <a href="/develop/framework/" class="nav-link">开发框架</a></li><li class="dropdown-item"><!----> <a href="/develop/algorithm/" class="nav-link">数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/develop/storage/" class="nav-link">数据存储</a></li><li class="dropdown-item"><!----> <a href="/develop/system/" class="nav-link">系统架构</a></li><li class="dropdown-item"><!----> <a href="/develop/network/" class="nav-link">计算机网络</a></li><li class="dropdown-item"><!----> <a href="/develop/cloud/" class="nav-link">云原生</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><a href="/tool/" class="link-title">工具</a> <span class="title" style="display:none;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tool/vcs/" class="nav-link">版本控制</a></li><li class="dropdown-item"><!----> <a href="/tool/network/" class="nav-link">网络工具</a></li><li class="dropdown-item"><!----> <a href="/tool/develop/" class="nav-link">开发工具</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><a href="/note/" class="link-title">学习笔记</a> <span class="title" style="display:none;">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/paper/" class="nav-link">学术搬砖</a></li><li class="dropdown-item"><!----> <a href="/note/project/" class="nav-link">实践项目</a></li><li class="dropdown-item"><!----> <a href="/note/lecture/" class="nav-link">讲座研讨</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="生活杂谈" class="dropdown-title"><a href="/life/" class="link-title">生活杂谈</a> <span class="title" style="display:none;">生活杂谈</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/life/year/" class="nav-link">随写编年</a></li><li class="dropdown-item"><!----> <a href="/life/youth/" class="nav-link">追忆青春</a></li><li class="dropdown-item"><!----> <a href="/life/travel/" class="nav-link">旅行日记</a></li><li class="dropdown-item"><!----> <a href="/life/art/" class="nav-link">文艺时光</a></li><li class="dropdown-item"><!----> <a href="/life/cook/" class="nav-link">烹调分享</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="资源收藏" class="dropdown-title"><a href="/resource/" class="link-title">资源收藏</a> <span class="title" style="display:none;">资源收藏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/resource/website/" class="nav-link">实用网站</a></li><li class="dropdown-item"><!----> <a href="/resource/project/" class="nav-link">优秀项目</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/more/interview/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/more/tip/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/more/blog/" class="nav-link">博客相关</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friend/" class="nav-link">友链</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/unique-pure/my-vdoing-blog-template" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程语言</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>开发框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据结构与算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据存储</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>系统架构</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>操作系统</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/77a74b/" class="sidebar-link">进程介绍</a></li><li><a href="/pages/1d4493/" class="sidebar-link">进程API</a></li><li><a href="/pages/4b8a3a/" class="sidebar-link">有限直接执行</a></li><li><a href="/pages/f0c724/" class="sidebar-link">CPU调度</a></li><li><a href="/pages/a1ad96/" class="sidebar-link">多级反馈队列</a></li><li><a href="/pages/40a229/" class="sidebar-link">比例份额调度</a></li><li><a href="/pages/326999/" class="sidebar-link">多CPU调度</a></li><li><a href="/pages/23b20c/" class="sidebar-link">地址空间</a></li><li><a href="/pages/174348/" class="sidebar-link">内存API</a></li><li><a href="/pages/542fcd/" class="sidebar-link">地址转换</a></li><li><a href="/pages/506cee/" class="sidebar-link">段</a></li><li><a href="/pages/d34e64/" class="sidebar-link">空闲空间管理</a></li><li><a href="/pages/69f0fb/" class="sidebar-link">页</a></li><li><a href="/pages/fe36b0/" class="sidebar-link">快表</a></li><li><a href="/pages/165f2d/" class="sidebar-link">高级页表</a></li><li><a href="/pages/65f57a/" class="sidebar-link">页面交换</a></li><li><a href="/pages/aeb7cb/" class="sidebar-link">交换策略</a></li><li><a href="/pages/9f0f28/" class="sidebar-link">完整VM系统</a></li><li><a href="/pages/1ef559/" class="sidebar-link">并发和线程</a></li><li><a href="/pages/2994ff/" class="sidebar-link">线程API</a></li><li><a href="/pages/fe4f25/" class="sidebar-link">锁</a></li><li><a href="/pages/396fa2/" class="sidebar-link">锁定数据结构</a></li><li><a href="/pages/463259/" class="sidebar-link">条件变量</a></li><li><a href="/pages/adf4ea/" class="sidebar-link">信号量</a></li><li><a href="/pages/a9671b/" aria-current="page" class="active sidebar-link">并发bug</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/a9671b/#_1-存在哪些类型的并发bug" class="sidebar-link">1 存在哪些类型的并发bug？</a></li><li class="sidebar-sub-header level2"><a href="/pages/a9671b/#_2-非死锁bug" class="sidebar-link">2 非死锁bug</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/a9671b/#_2-1-原子性违规bug" class="sidebar-link">2.1 原子性违规bug</a></li><li class="sidebar-sub-header level3"><a href="/pages/a9671b/#_2-2-顺序违规bug" class="sidebar-link">2.2 顺序违规bug</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/a9671b/#_3-死锁bug" class="sidebar-link">3 死锁bug</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/a9671b/#_3-1-基本介绍" class="sidebar-link">3.1 基本介绍</a></li><li class="sidebar-sub-header level3"><a href="/pages/a9671b/#_3-2-为什么会出现死锁" class="sidebar-link">3.2 为什么会出现死锁</a></li><li class="sidebar-sub-header level3"><a href="/pages/a9671b/#_3-3-死锁原因" class="sidebar-link">3.3 死锁原因</a></li><li class="sidebar-sub-header level3"><a href="/pages/a9671b/#_3-4-预防死锁" class="sidebar-link">3.4 预防死锁</a></li><li class="sidebar-sub-header level4"><a href="/pages/a9671b/#_3-4-1-循环等待" class="sidebar-link">3.4.1 循环等待</a></li><li class="sidebar-sub-header level4"><a href="/pages/a9671b/#_3-4-2-持有并等待" class="sidebar-link">3.4.2 持有并等待</a></li><li class="sidebar-sub-header level4"><a href="/pages/a9671b/#_3-4-3-不可抢占" class="sidebar-link">3.4.3 不可抢占</a></li><li class="sidebar-sub-header level4"><a href="/pages/a9671b/#_3-4-4-互斥" class="sidebar-link">3.4.4 互斥</a></li><li class="sidebar-sub-header level3"><a href="/pages/a9671b/#_3-5-通过调度避免死锁" class="sidebar-link">3.5 通过调度避免死锁</a></li><li class="sidebar-sub-header level3"><a href="/pages/a9671b/#_3-6-检测和恢复" class="sidebar-link">3.6 检测和恢复</a></li></ul></li></ul></li><li><a href="/pages/19d9ef/" class="sidebar-link">基于事件的并发</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>分布式系统</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>云原生</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/develop/#开发" data-v-06225672>开发</a></li><li data-v-06225672><a href="/develop/#系统架构" data-v-06225672>系统架构</a></li><li data-v-06225672><a href="/develop/#操作系统" data-v-06225672>操作系统</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/unique-pure" target="_blank" title="作者" class="beLink" data-v-06225672>Pursuit</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-05-11</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">并发bug<!----></h1>  <div class="theme-vdoing-content content__default"><h2 id="_1-存在哪些类型的并发bug"><a href="#_1-存在哪些类型的并发bug" class="header-anchor">#</a> 1 存在哪些类型的并发bug？</h2> <p>第一个也是最明显的问题是：复杂的并发程序中会出现哪些类型的并发bug？这个问题一般来说很难回答，但幸运的是，其他一些人已经为我们完成了这项工作。具体来说，我们依赖于 Lu 等人的一项研究。它详细分析了许多流行的并发应用程序，以了解实践中出现的bug类型。</p> <p>该研究重点关注四个主要且重要的开源应用程序：MySQL（流行的数据库管理系统）、Apache（著名的 Web 服务器）、Mozilla（著名的 Web 浏览器）和 OpenOffice（MS Office 套件的免费版本，有些人实际使用）。在这项研究中，作者研究了在每个代码库中发现并修复的并发性bug，将开发人员的工作转化为定量bug分析；了解这些结果可以帮助您了解成熟代码库中实际发生的问题类型。</p> <p>下图显示了 Lu 及其同事研究的bug汇总。从图中可以看出，总共有 105 个bug，其中大部分不是死锁（74 个）；其余 31 个是死锁bug。此外，您还可以看到每个应用程序的bug数量；OpenOffice 的并发bug总数只有 8 个，而 Mozilla 则有近 60 个。</p> <p><img src="https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/Bugs_In_Modern_Applications.png" alt="image-20240411160133229"></p> <p>我们现在对这些不同类别的bug（非死锁、死锁）进行更深入的研究。对于第一类非死锁bug，我们将使用研究中的示例进行讨论。对于第二类死锁bug，我们将讨论在预防、避免或处理死锁方面所做的大量工作。</p> <h2 id="_2-非死锁bug"><a href="#_2-非死锁bug" class="header-anchor">#</a> 2 非死锁bug</h2> <p>根据 Lu 的研究，非死锁bug占并发bug的大多数。但这些bug属于哪种类型？它们是如何产生的？我们该如何修复它们？我们现在讨论 Lu 等人发现的两大类非死锁bug：原子性违规bug和顺序违规bug。</p> <h3 id="_2-1-原子性违规bug"><a href="#_2-1-原子性违规bug" class="header-anchor">#</a> 2.1 原子性违规bug</h3> <p>遇到的第一类问题被称为原子性违规。下面是一个在 MySQL 中发现的简单示例。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>Thread <span class="token number">1</span><span class="token operator">::</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>thd<span class="token operator">-&gt;</span>proc_info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token function">fputs</span><span class="token punctuation">(</span>thd<span class="token operator">-&gt;</span>proc_info<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

Thread <span class="token number">2</span><span class="token operator">::</span>
thd<span class="token operator">-&gt;</span>proc_info <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在示例中，两个不同的线程访问了结构体 <code>thd</code> 中的字段 <code>proc_info</code>。第一个线程检查值是否为非空值，然后打印其值；第二个线程将其设置为空值。显然，如果第一个线程执行了检查，但在调用 <code>fputs</code> 之前被中断，那么第二个线程可能会在中间运行，从而将指针设置为 NULL；当第一个线程恢复运行时，它将崩溃，因为 NULL 指针将被 <code>fputs</code> 解除引用。</p> <p>根据 Lu 等人的说法，原子性违规的更正式定义是：<font color="red">“违反了多个内存访问之间所需的可串行性（即代码区域应该是原子性的，但在执行过程中并未强制执行原子性）。”</font>在上面的示例中，代码对 <code>proc_info</code> 的非 NULL 检查以及 <code>fputs()</code> 调用中 <code>proc_info</code> 的使用有一个原子性假设（用 Lu 的话说）；当假设不正确时，代码将无法按预期工作。</p> <p>找到此类问题的解决方案通常（但并非总是）很简单。在此解决方案中，我们只需在共享变量引用周围添加锁，确保当任一线程访问 <code>proc_info</code> 字段时，它都持有锁（<code>proc_info_lock</code>）。当然，访问该结构的任何其他代码也应该在执行此操作之前获取此锁。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token class-name">pthread_mutex_t</span> proc_info_lock <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span>

Thread <span class="token number">1</span><span class="token operator">::</span>
<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc_info_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>thd<span class="token operator">-&gt;</span>proc_info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token function">fputs</span><span class="token punctuation">(</span>thd<span class="token operator">-&gt;</span>proc_info<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc_info_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

Thread <span class="token number">2</span><span class="token operator">::</span>
<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc_info_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
thd<span class="token operator">-&gt;</span>proc_info <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc_info_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="_2-2-顺序违规bug"><a href="#_2-2-顺序违规bug" class="header-anchor">#</a> 2.2 顺序违规bug</h3> <p>Lu 等人发现的另一种常见的非死锁bug被称为 &quot;顺序违规&quot;。下面是另一个简单的例子。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>Thread <span class="token number">1</span><span class="token operator">::</span>
<span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mThread <span class="token operator">=</span> <span class="token function">PR_CreateThread</span><span class="token punctuation">(</span>mMain<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

Thread <span class="token number">2</span><span class="token operator">::</span>
<span class="token keyword">void</span> <span class="token function">mMain</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mState <span class="token operator">=</span> mThread<span class="token operator">-&gt;</span>State<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>线程 2 中的代码似乎假定变量 <code>mThread</code> 已被初始化（并且不是 NULL）；但是，如果线程 2 创建后立即运行，那么在线程 2 的 <code>mMain()</code> 中访问 <code>mThread</code> 时，它的值将不会被设置，并且很可能会因解引用 NULL 指针而崩溃。请注意，我们假设 <code>mThread</code> 的值最初为 NULL；如果不是，那么在线程 2 中通过解引用访问任意内存位置时，可能会发生更奇怪的事情。</p> <p>违反顺序的更正式定义是这样的：<font color="red">&quot;两个（组）内存访问之间的理想顺序被颠倒（即 A 应总是在 B 之前执行，但在执行过程中顺序并没有被强制执行）&quot;。</font></p> <p>解决这类bug的方法一般是强制执行排序。正如我们之前详细讨论过的，使用<strong>条件变量</strong>是将这种同步方式添加到现代代码库中的一种简单而稳健的方法。在上面的例子中，我们可以将代码重写如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token class-name">pthread_mutex_t</span> mtLock <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span>
<span class="token class-name">pthread_cond_t</span> 	mtCond <span class="token operator">=</span> PTHREAD_COND_INITIALIZER<span class="token punctuation">;</span>
<span class="token keyword">int</span> mtInit 			   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

Thread <span class="token number">1</span><span class="token operator">::</span>
<span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mThread <span class="token operator">=</span> <span class="token function">PR_CreateThread</span><span class="token punctuation">(</span>mMain<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// signal that the thread has been created...</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mtLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mtInit <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mtCond<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mtLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

Thread <span class="token number">2</span><span class="token operator">::</span>
<span class="token keyword">void</span> <span class="token function">mMain</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// wait for the thread to be initialized...</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mtLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>mtInit <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mtCond<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mtLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mtLock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mState <span class="token operator">=</span> mThread<span class="token operator">-&gt;</span>State<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>在这个固定的代码序列中，我们添加了一个锁（<code>mtLock</code>）和相应的条件变量（<code>mtCond</code>），以及一个状态变量（<code>mtInit</code>）。初始化代码运行时，它会将 <code>mtInit</code> 的状态设置为 1，并发出信号表示已完成设置。如果线程 2 在这之前运行，它将等待这个信号和相应的状态变化；如果线程 2 在之后运行，它将检查状态，发现初始化已经发生（即 <code>mtInit</code> 被设置为 1），从而继续正常运行。需要注意的是，我们可以使用 <code>mThread</code> 作为状态变量本身，但为了简单起见，这里不这样做。当线程之间需要排序时，条件变量（或 信号量）就能派上用场。</p> <h2 id="_3-死锁bug"><a href="#_3-死锁bug" class="header-anchor">#</a> 3 死锁bug</h2> <h3 id="_3-1-基本介绍"><a href="#_3-1-基本介绍" class="header-anchor">#</a> 3.1 基本介绍</h3> <p>除了上面提到的并发bug，在许多具有复杂锁定协议的并发系统中还会出现一个典型的问题，即死锁。例如，当一个线程（例如线程 1）持有一个锁（L1）并等待另一个锁（L2）时，就会出现死锁；不幸的是，持有锁 L2 的线程（线程 2）正在等待 L1 被释放。下面的代码片段演示了这种潜在的死锁：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>Thread <span class="token number">1</span><span class="token operator">:</span> 					Thread <span class="token number">2</span><span class="token operator">:</span>
<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span>L1<span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span>L2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span>L2<span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span>L1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>注意，如果这段代码运行，并不一定会发生死锁；相反，如果线程 1 获取锁 L1，然后线程 2 发生上下文切换，则可能会发生这种情况。此时，线程 2 获取 L2，并尝试获取 L1。因此，我们遇到了死锁，因为每个线程都在等待另一个线程，而两个线程都无法运行。</p> <p>如下图所示，图中出现循环就表明出现了死锁。这张图应该能说明问题。程序员应该如何编写代码以便以某种方式处理死锁？我们问题的关键是我们应该如何构建系统来预防、避免或至少检测死锁并从中恢复？这是当今系统中真正的问题吗？</p> <p><img src="https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/The-Deadlock-Dependency-Graph.png" alt="image-20240411184424257"></p> <h3 id="_3-2-为什么会出现死锁"><a href="#_3-2-为什么会出现死锁" class="header-anchor">#</a> 3.2 为什么会出现死锁</h3> <p>你可能会想，像上面这样的简单死锁似乎很容易避免。例如，如果线程 1 和线程 2 都确保以相同的顺序抓取锁，死锁就永远不会出现。那么，为什么会出现死锁呢？</p> <p>其中一个原因是，在大型代码库中，组件之间会产生复杂的依赖关系。以操作系统为例。虚拟内存系统可能需要访问文件系统，以便从磁盘分页读入一个数据块；文件系统随后可能需要一个内存页来读入该数据块，从而与虚拟内存系统发生关联。因此，在大型系统中设计锁定策略时必须小心谨慎，以避免代码中可能自然出现的循环依赖关系造成死锁。</p> <p>另一个原因是<strong>封装</strong>的本质。作为软件开发人员，我们被教导要隐藏实现的细节，从而使软件更容易以模块化的方式构建。遗憾的是，这种模块化与锁定并不匹配。正如 Jula 等人所指出的，一些看似无害的接口几乎会让你陷入死锁。例如，以 Java 向量类和 <code>AddAll()</code> 方法为例。这个例程的调用过程如下</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>Vector v1<span class="token punctuation">,</span> v2<span class="token punctuation">;</span>
v1<span class="token punctuation">.</span><span class="token function">AddAll</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在内部，由于该方法需要是多线程安全的，因此需要获取添加到 (v1) 的向量和参数 (v2) 的锁。该例程以某种任意顺序获取所述锁（先是 v1，然后是 v2），以便将 v2 的内容添加到 v1。如果其他线程几乎同时调用 <code>v2.AddAll(v1)</code>，则可能会出现死锁，而所有这些都对调用应用程序来说是隐藏的。</p> <h3 id="_3-3-死锁原因"><a href="#_3-3-死锁原因" class="header-anchor">#</a> 3.3 死锁原因</h3> <p>发生死锁需要满足四个条件：</p> <ol><li><strong>互斥</strong>：线程声明对其所需资源的独占控制（例如，线程获取锁）。</li> <li><strong>持有并等待</strong>：线程持有分配给它们的资源（例如，它们已经获取的锁），同时等待其他资源（例如，它们希望获取的锁）。</li> <li><strong>不可抢占</strong>：无法从持有资源的线程中强制删除资源（例如锁）。</li> <li><strong>循环等待</strong>：存在循环线程链，使得每个线程持有链中下一个线程正在请求的一个或多个资源（例如，锁）。</li></ol> <p>如果这四个条件中任何一个不满足，就不会发生死锁。因此，我们首先探索防止死锁的技术；这些策略中的每一个都旨在防止出现上述情况之一，因此是处理死锁问题的一种方法。</p> <h3 id="_3-4-预防死锁"><a href="#_3-4-预防死锁" class="header-anchor">#</a> 3.4 预防死锁</h3> <h4 id="_3-4-1-循环等待"><a href="#_3-4-1-循环等待" class="header-anchor">#</a> 3.4.1 循环等待</h4> <p>最实用的预防方法（当然也是经常使用的方法）可能是编写锁定代码，使其永远不会引起循环等待条件。要做到这一点，最直接的方法就是为锁的获取提供一个<strong>总排序</strong>。例如，如果系统中只有两个锁（<code>L1</code> 和<code>L2</code>），则可以通过始终在 <code>L2</code> 之前获取 <code>L1</code> 来防止死锁。这种严格的排序可以确保不会出现循环等待，从而避免死锁。</p> <p>当然，在更复杂的系统中，会存在两个以上的锁，因此很难实现完全的锁排序（也许根本没有必要）。因此，部分排序可以有效地构建锁获取结构，从而避免死锁。Linux 中的内存映射代码就是一个很好的部分锁排序的真实例子；源代码顶部的注释揭示了十组不同的锁获取顺序，包括简单的如 &quot;<code>i_mutex</code> before <code>i_mmap_mutex</code> &quot;和更复杂的如 &quot;<code>i_mmap_mutex</code> before <code>private_lock</code> before <code>swap_lock</code> before <code>mapping-&gt;tree_lock</code>&quot;。</p> <p>可以想象，无论是全部排序还是部分排序，都需要精心设计锁定策略，而且必须非常谨慎。此外，排序只是一种惯例，马虎的程序员很容易忽略锁定协议，并可能导致死锁。最后，锁排序要求对代码库以及各种例程的调用方式有深入的了解；只要有一个bug，就可能导致死锁。</p> <blockquote><center>TIP：通过锁地址强制执行锁排序</center> <p>在某些情况下，一个函数必须获取两个（或更多）锁；因此，我们知道我们必须小心，否则可能会出现死锁。想象一个按如下方式调用的函数：<code>do_something(mutex_t *m1, mutex_t *m2)</code>。如果代码总是在 <code>m2</code> 之前获取 <code>m1</code>（或者总是在 <code>m1</code> 之前获取 <code>m2</code>），则可能会死锁，因为一个线程可以调用 <code>do_something(L1, L2)</code>，而另一个线程可以调用 <code>do_something(L2, L1)</code>。</p> <p>为了避免这个特殊问题，聪明的程序员可以使用每个锁的地址作为获取锁的顺序。通过以从高到低或从低到高的地址顺序获取锁，<code>do_something()</code> 可以保证它始终以相同的顺序获取锁，无论它们传入的顺序如何。代码看起来像这样这：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>m1 <span class="token operator">&gt;</span> m2<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// grab locks in high-to-low address order</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span>m1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span>m2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span>m2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span>m1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// Code assumes that m1 != m2 (it is not the same lock)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>通过使用这种简单的技术，程序员可以确保简单高效地实现无死锁的多锁获取。</p></blockquote> <h4 id="_3-4-2-持有并等待"><a href="#_3-4-2-持有并等待" class="header-anchor">#</a> 3.4.2 持有并等待</h4> <p>通过原子方式一次性获取所有锁，可以避免死锁的保持和等待要求。在实际操作中，可以通过以下方式实现：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span>prevention<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// begin lock acquisition</span>
<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span>L1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span>L2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span>prevention<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>通过首先获取锁<code>prevention</code>，此代码确保在获取锁时不会发生任何不及时的线程切换，从而再次避免死锁。当然，这要求任何时候任何线程抓取一个锁时，它首先获取全局预防锁。例如，如果另一个线程尝试以不同顺序抓取锁<code>L1</code>和<code>L2</code>，则是可以的，因为在这样做时它将持有<code>prevention</code>锁。</p> <p>请注意，由于多种原因，该解决方案存在问题。和以前一样，封装对我们不利：当调用例程时，这种方法要求我们准确地知道必须持有哪些锁并提前获取它们。这种技术还可能会降低并发性，因为所有锁都必须尽早（立即）获取，而不是在真正需要时获取。</p> <h4 id="_3-4-3-不可抢占"><a href="#_3-4-3-不可抢占" class="header-anchor">#</a> 3.4.3 不可抢占</h4> <p>因为我们通常将锁视为一直保持到调用解锁为止，所以多次获取锁常常会给我们带来麻烦，因为在等待一个锁时，我们正在持有另一个锁。许多线程库提供了一组更灵活的接口来帮助避免这种情况。具体来说，例程 <code>pthread_mutex_trylock()</code> 要么获取锁（如果可用）并返回成功，要么返回指示锁已被持有的bug代码；在后一种情况下，如果您想抓住该锁，可以稍后重试。</p> <p>这样的接口可以按如下方式使用来构建无死锁、有序鲁棒的锁获取协议：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>top<span class="token operator">:</span>
<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span>L1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_mutex_trylock</span><span class="token punctuation">(</span>L2<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span>L1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> top<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>需要注意的是，另一个线程可以遵循相同的协议，但以另一种顺序（先 <code>L2</code> 后 <code>L1</code>）获取锁，这样程序仍然不会出现死锁。然而，一个新的问题出现了：<strong>活锁</strong>。两个线程有可能（虽然可能性不大）都在重复尝试这种顺序，但多次都无法获得两个锁。在这种情况下，两个系统都在重复运行这个代码序列（因此不是死锁），但却没有取得进展，因此被称为活锁。活锁问题也有解决方法：例如，可以在循环之前添加一个随机延迟，然后重新尝试整个过程，从而降低竞争线程之间重复干扰的几率。</p> <p>关于这个解决方案的一点是：它绕过了使用 <code>trylock</code> 方法的难点。第一个可能再次出现的问题是封装：如果这些锁中的一个被埋在某个被调用的例程中，那么跳回起点的实现就会变得更加复杂。<font color="red">例如，如果在获取 L1 后，代码分配了一些内存，那么在获取 L2 失败后，就必须释放这些内存，然后再跳回到顶层，重新尝试整个序列。</font>不过，在有限的情况下（例如前面提到的 Java 向量方法），这种方法可能会很有效。</p> <p>你可能还会注意到，这种方法并没有真正加入抢占（从拥有锁的线程中强行夺走锁的操作），而是使用 <code>trylock</code> 方法允许开发者以一种优雅的方式退出锁的所有权（即抢占自己的所有权）。不过，这是一种实用的方法，因此尽管在这方面并不完美，我们还是将其包含在这里。</p> <h4 id="_3-4-4-互斥"><a href="#_3-4-4-互斥" class="header-anchor">#</a> 3.4.4 互斥</h4> <p>最后一种防范技术是完全避免互斥。一般来说，我们知道这很困难，因为我们希望运行的代码确实存在临界区。那么我们能做些什么呢？</p> <p>Herlihy 提出了一个想法：我们可以设计各种完全不需要锁的数据结构。这些无锁（以及相关的无等待）方法背后的理念很简单：利用强大的硬件指令，可以以不需要显式锁定的方式构建数据结构。</p> <p>举个简单的例子，假设我们有一条比较和交换指令，你可能还记得这是一条由硬件提供的原子指令，它的作用如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">CompareAndSwap</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>address<span class="token punctuation">,</span> <span class="token keyword">int</span> expected<span class="token punctuation">,</span> <span class="token keyword">int</span> new<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>address <span class="token operator">==</span> expected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>address <span class="token operator">=</span> new<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// success</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// failure</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>想象一下，我们现在想以原子方式将一个值递增一定量。我们可以这样做：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">AtomicIncrement</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>value<span class="token punctuation">,</span> <span class="token keyword">int</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> old <span class="token operator">=</span> <span class="token operator">*</span>value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">CompareAndSwap</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> old<span class="token punctuation">,</span> old <span class="token operator">+</span> amount<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>我们没有获取锁，进行更新，然后释放它，而是构建了一种方法，反复尝试将值更新为心智并使用<code>CompareAndSwap</code>来执行此操作。通过这种方式，不会获取锁，并且不会出现死锁（尽管活锁仍然是可能的）。</p> <p>让我们考虑一个稍微复杂的例子：列表插入。以下是在列表头部插入的代码：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">node_t</span> <span class="token operator">*</span>n <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">node_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    n<span class="token operator">-&gt;</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    n<span class="token operator">-&gt;</span>next <span class="token operator">=</span> head<span class="token punctuation">;</span>
    head <span class="token operator">=</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这段代码执行简单的插入操作，但如果多个线程 &quot;同时 &quot;调用，就会出现竞争条件。当然，我们可以用获取和释放锁来解决这个问题：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">node_t</span> <span class="token operator">*</span>n <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">node_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    n<span class="token operator">-&gt;</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span>listlock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// begin critical section</span>
    n<span class="token operator">-&gt;</span>next <span class="token operator">=</span> head<span class="token punctuation">;</span>
    head <span class="token operator">=</span> n<span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span>listlock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// end critical section</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在这个解决方案中，我们使用了传统的锁。相反，我们可以尝试使用<code>CompareAndSwap</code>指令，以无锁定方式执行插入操作。下面是一种可行的方法：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">node_t</span> <span class="token operator">*</span>n <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">node_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    n<span class="token operator">-&gt;</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        n<span class="token operator">-&gt;</span>next <span class="token operator">=</span> head<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">CompareAndSwap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>head<span class="token punctuation">,</span> n<span class="token operator">-&gt;</span>next<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这里的代码会更新下一个指针，使其指向当前头部，然后尝试将新创建的节点交换到列表的新头部。但是，如果其他线程在此期间成功地交换了一个新的头，那么这个操作就会失败，从而导致这个线程用新的头再次重试。</p> <p>当然，建立一个有用的列表需要的不仅仅是列表插入，毫不奇怪，建立一个能以无锁方式插入、删除和执行查找的列表并非易事。</p> <h3 id="_3-5-通过调度避免死锁"><a href="#_3-5-通过调度避免死锁" class="header-anchor">#</a> 3.5 通过调度避免死锁</h3> <p>在某些情况下，避免死锁比预防死锁更可取。避免死锁需要一些全局知识，了解各个线程在执行期间可能会获取哪些锁，并随后以保证不会发生死锁的方式调度所述线程。</p> <p>例如，假设我们有两个处理器和四个线程，必须在它们上进行调度。进一步假设我们知道线程 1 (<code>T1</code>) 获取锁 <code>L1</code> 和 <code>L2</code>（以某种顺序，在执行期间的某个时刻），<code>T2</code> 也获取 <code>L1</code> 和 <code>L2</code>，<code>T3</code> 仅获取 <code>L2</code>，而 <code>T4</code> 根本不获取锁。我们可以以表格形式展示线程的这些锁获取需求：</p> <table><thead><tr><th style="text-align:center;"></th> <th style="text-align:center;">T1</th> <th style="text-align:center;">T2</th> <th style="text-align:center;">T3</th> <th style="text-align:center;">T4</th></tr></thead> <tbody><tr><td style="text-align:center;">L1</td> <td style="text-align:center;">yes</td> <td style="text-align:center;">yes</td> <td style="text-align:center;">no</td> <td style="text-align:center;">no</td></tr> <tr><td style="text-align:center;">L2</td> <td style="text-align:center;">yes</td> <td style="text-align:center;">yes</td> <td style="text-align:center;">yes</td> <td style="text-align:center;">no</td></tr></tbody></table> <p>因此，智能调度程序可以计算出，只要 <code>T1</code> 和 <code>T2</code> 不同时运行，就不会出现死锁。下面就是这样一个调度程序：</p> <p><img src="https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/CPU_Scheduler_Example.png" alt="image-20240411195407552"></p> <p>请注意，（<code>T3</code> 和 <code>T1</code>）或（<code>T3</code> 和 <code>T2</code>）是可以重叠的。即使 <code>T3</code> 抓住了锁 <code>L2</code>，它也不会因为与其他线程同时运行而导致死锁，因为它只抓住了一个锁。让我们再看一个例子。在这个例子中，对相同资源（同样是锁 <code>L1</code> 和 <code>L2</code>）的争用更多，如下面的争用表所示：</p> <table><thead><tr><th style="text-align:center;"></th> <th style="text-align:center;">T1</th> <th style="text-align:center;">T2</th> <th style="text-align:center;">T3</th> <th style="text-align:center;">T4</th></tr></thead> <tbody><tr><td style="text-align:center;">L1</td> <td style="text-align:center;">yes</td> <td style="text-align:center;">yes</td> <td style="text-align:center;">Yes</td> <td style="text-align:center;">no</td></tr> <tr><td style="text-align:center;">L2</td> <td style="text-align:center;">yes</td> <td style="text-align:center;">yes</td> <td style="text-align:center;">yes</td> <td style="text-align:center;">no</td></tr></tbody></table> <p>其中，线程 <code>T1</code>、<code>T2</code> 和 <code>T3</code> 都需要在执行过程中的某个时刻同时抓住锁 <code>L1</code> 和 <code>L2</code>。下面是一个可以保证不发生死锁的调度表：</p> <p><img src="https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/CPU_Scheduler_Example_2.png" alt="image-20240411195925218"></p> <p>正如你所看到的，静态调度导致了一种保守的方法，即 <code>T1</code>、<code>T2</code> 和 <code>T3</code> 都在同一个处理器上运行，因此完成作业的总时间大大延长。虽然这些任务有可能同时运行，但由于担心死锁，我们无法这样做，而代价就是性能。</p> <p>Dijkstra 的银行家算法就是这种方法的一个著名例子。遗憾的是，这些方法只在非常有限的环境中有用，例如，在嵌入式系统中，人们完全了解必须运行的全部任务集及其所需的锁。此外，这种方法还会限制并发性，正如我们在上文第二个例子中看到的那样。因此，通过调度避免死锁并不是一种广泛使用的通用解决方案。</p> <h3 id="_3-6-检测和恢复"><a href="#_3-6-检测和恢复" class="header-anchor">#</a> 3.6 检测和恢复</h3> <p>最后一个通用策略是允许死锁偶尔发生，然后在检测到死锁后采取一些措施。例如，如果操作系统每年都会出现一次死锁，那么你只需重启操作系统，然后继续愉快地（或暴躁地）工作。如果死锁很少发生，那么这种不解决问题的方法确实非常实用。</p> <p>许多数据库系统都采用了死锁检测和恢复技术。死锁检测器定期运行，构建资源图并检查其是否存在循环。一旦出现循环（死锁），系统就需要重新启动。如果首先需要对数据结构进行更复杂的修复，则可能需要人工参与，以简化修复过程。</p></div></div> <div class="page-slot page-slot-bottom"><div class="donation">
      <button>打赏</button>
      <div class="main">
        <div class="pic">
          <img src="https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/wechatpay.jpeg" alt="微信">
          <img src="https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/zhifubaopay.jpeg" alt="支付宝">
        </div>
      </div>  
    </div></div> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=OS" title="标签">#OS</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/05/11, 20:58:35</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/adf4ea/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">信号量</div></a> <a href="/pages/19d9ef/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">基于事件的并发</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/adf4ea/" class="prev">信号量</a></span> <span class="next"><a href="/pages/19d9ef/">基于事件的并发</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/19d9ef/"><div>
            基于事件的并发
            <!----></div></a> <span class="date">05-11</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/adf4ea/"><div>
            信号量
            <!----></div></a> <span class="date">05-11</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/463259/"><div>
            条件变量
            <!----></div></a> <span class="date">05-11</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:unique.hzf@gmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/unique-pure" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://pursuit.blog.csdn.net/" title="My CSDN" target="_blank" class="iconfont icon-csdn"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2020-2024
    <span>Pursuit | <a href="https://github.com/unique-pure/my-vdoing-blog-template/blob/main/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><!----><div></div><WebInfo></WebInfo><PageInfo></PageInfo><div></div></div></div>
    <script src="/assets/js/app.f72d119d.js" defer></script><script src="/assets/js/4.71a85121.js" defer></script><script src="/assets/js/1.4a1189e9.js" defer></script><script src="/assets/js/3.bca043f9.js" defer></script><script src="/assets/js/124.51fabad6.js" defer></script><script src="/assets/js/20.bc1029fc.js" defer></script>
  </body>
</html>
