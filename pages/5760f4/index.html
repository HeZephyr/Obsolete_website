<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MIT 6.5840(6.824) 使用Go进行线程和RPC编程 | Pursuit&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="随便写写">
    <meta name="keywords" content="python,Go,C++,git,github,markdown,database,mysql,redis">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.a3990aec.css" as="style"><link rel="preload" href="/assets/js/app.8593a971.js" as="script"><link rel="preload" href="/assets/js/4.71a85121.js" as="script"><link rel="preload" href="/assets/js/1.4a1189e9.js" as="script"><link rel="preload" href="/assets/js/3.bca043f9.js" as="script"><link rel="preload" href="/assets/js/142.eb9d5fe6.js" as="script"><link rel="preload" href="/assets/js/20.bc1029fc.js" as="script"><link rel="prefetch" href="/assets/js/10.ce2d8b4d.js"><link rel="prefetch" href="/assets/js/100.390ccbcf.js"><link rel="prefetch" href="/assets/js/101.3c43ba2e.js"><link rel="prefetch" href="/assets/js/102.a68076c1.js"><link rel="prefetch" href="/assets/js/103.78ac82ac.js"><link rel="prefetch" href="/assets/js/104.ce74ea62.js"><link rel="prefetch" href="/assets/js/105.957253b3.js"><link rel="prefetch" href="/assets/js/106.3dc74f52.js"><link rel="prefetch" href="/assets/js/107.a884d6d7.js"><link rel="prefetch" href="/assets/js/108.fbb09351.js"><link rel="prefetch" href="/assets/js/109.1d076fc4.js"><link rel="prefetch" href="/assets/js/11.87208a0c.js"><link rel="prefetch" href="/assets/js/110.8cf37885.js"><link rel="prefetch" href="/assets/js/111.12a7bb8a.js"><link rel="prefetch" href="/assets/js/112.126c8c5d.js"><link rel="prefetch" href="/assets/js/113.93d76526.js"><link rel="prefetch" href="/assets/js/114.a280068c.js"><link rel="prefetch" href="/assets/js/115.666bd400.js"><link rel="prefetch" href="/assets/js/116.8dffd4ba.js"><link rel="prefetch" href="/assets/js/117.dc2320a9.js"><link rel="prefetch" href="/assets/js/118.c2cc2fc1.js"><link rel="prefetch" href="/assets/js/119.1f6310e7.js"><link rel="prefetch" href="/assets/js/12.7f5cceef.js"><link rel="prefetch" href="/assets/js/120.30e3f860.js"><link rel="prefetch" href="/assets/js/121.29b5b320.js"><link rel="prefetch" href="/assets/js/122.a10dc403.js"><link rel="prefetch" href="/assets/js/123.b13a08cd.js"><link rel="prefetch" href="/assets/js/124.2a44effd.js"><link rel="prefetch" href="/assets/js/125.df459912.js"><link rel="prefetch" href="/assets/js/126.1d8f3931.js"><link rel="prefetch" href="/assets/js/127.178a0262.js"><link rel="prefetch" href="/assets/js/128.7ab0cd33.js"><link rel="prefetch" href="/assets/js/129.39dad0cf.js"><link rel="prefetch" href="/assets/js/13.f2cea533.js"><link rel="prefetch" href="/assets/js/130.771ade67.js"><link rel="prefetch" href="/assets/js/131.65cb216a.js"><link rel="prefetch" href="/assets/js/132.8b0d824c.js"><link rel="prefetch" href="/assets/js/133.a3dfa9d2.js"><link rel="prefetch" href="/assets/js/134.0b353dca.js"><link rel="prefetch" href="/assets/js/135.58d1cb75.js"><link rel="prefetch" href="/assets/js/136.d76c834f.js"><link rel="prefetch" href="/assets/js/137.e651d8a1.js"><link rel="prefetch" href="/assets/js/138.3d293a56.js"><link rel="prefetch" href="/assets/js/139.07de1e21.js"><link rel="prefetch" href="/assets/js/14.f8459573.js"><link rel="prefetch" href="/assets/js/140.be8b63b5.js"><link rel="prefetch" href="/assets/js/141.4e01bc4b.js"><link rel="prefetch" href="/assets/js/143.a82c43cd.js"><link rel="prefetch" href="/assets/js/144.04df2223.js"><link rel="prefetch" href="/assets/js/145.07a515e1.js"><link rel="prefetch" href="/assets/js/146.f6ae2d0a.js"><link rel="prefetch" href="/assets/js/147.56a2bdbe.js"><link rel="prefetch" href="/assets/js/148.6088ca7a.js"><link rel="prefetch" href="/assets/js/149.2d5e63f2.js"><link rel="prefetch" href="/assets/js/15.06cd6cc8.js"><link rel="prefetch" href="/assets/js/150.c8d8256b.js"><link rel="prefetch" href="/assets/js/151.72ba072f.js"><link rel="prefetch" href="/assets/js/152.5c606312.js"><link rel="prefetch" href="/assets/js/153.600c8f7f.js"><link rel="prefetch" href="/assets/js/154.4c418835.js"><link rel="prefetch" href="/assets/js/155.e1a4fd06.js"><link rel="prefetch" href="/assets/js/156.4597166f.js"><link rel="prefetch" href="/assets/js/157.f7a66b5b.js"><link rel="prefetch" href="/assets/js/158.2c8e9017.js"><link rel="prefetch" href="/assets/js/159.3b456dcd.js"><link rel="prefetch" href="/assets/js/16.33942615.js"><link rel="prefetch" href="/assets/js/160.9187f815.js"><link rel="prefetch" href="/assets/js/161.9c55391e.js"><link rel="prefetch" href="/assets/js/162.ba8fe7fd.js"><link rel="prefetch" href="/assets/js/163.a14000e2.js"><link rel="prefetch" href="/assets/js/164.22afc656.js"><link rel="prefetch" href="/assets/js/165.0c9e2449.js"><link rel="prefetch" href="/assets/js/166.9e7ad163.js"><link rel="prefetch" href="/assets/js/167.1ef6e855.js"><link rel="prefetch" href="/assets/js/168.7e7d7fdd.js"><link rel="prefetch" href="/assets/js/169.f07df49e.js"><link rel="prefetch" href="/assets/js/17.da2e0126.js"><link rel="prefetch" href="/assets/js/170.34060290.js"><link rel="prefetch" href="/assets/js/171.e5083adb.js"><link rel="prefetch" href="/assets/js/172.84729660.js"><link rel="prefetch" href="/assets/js/173.ede0d093.js"><link rel="prefetch" href="/assets/js/174.2661a505.js"><link rel="prefetch" href="/assets/js/175.a9886db2.js"><link rel="prefetch" href="/assets/js/176.7bfa9ade.js"><link rel="prefetch" href="/assets/js/177.f35f351b.js"><link rel="prefetch" href="/assets/js/178.0076da7e.js"><link rel="prefetch" href="/assets/js/18.a39b8ae2.js"><link rel="prefetch" href="/assets/js/19.1760f287.js"><link rel="prefetch" href="/assets/js/2.8e76b5b7.js"><link rel="prefetch" href="/assets/js/21.4b161474.js"><link rel="prefetch" href="/assets/js/22.69d29451.js"><link rel="prefetch" href="/assets/js/23.2a87052f.js"><link rel="prefetch" href="/assets/js/24.6beeaf9b.js"><link rel="prefetch" href="/assets/js/25.e9d4e312.js"><link rel="prefetch" href="/assets/js/26.c128f1d5.js"><link rel="prefetch" href="/assets/js/27.2bab9253.js"><link rel="prefetch" href="/assets/js/28.0b0ea581.js"><link rel="prefetch" href="/assets/js/29.71a2a1e9.js"><link rel="prefetch" href="/assets/js/30.11fd1987.js"><link rel="prefetch" href="/assets/js/31.92abb231.js"><link rel="prefetch" href="/assets/js/32.27d7c672.js"><link rel="prefetch" href="/assets/js/33.9f002fe8.js"><link rel="prefetch" href="/assets/js/34.39abd7b3.js"><link rel="prefetch" href="/assets/js/35.a54492ae.js"><link rel="prefetch" href="/assets/js/36.1b3ef370.js"><link rel="prefetch" href="/assets/js/37.3dda47b6.js"><link rel="prefetch" href="/assets/js/38.3dc3656a.js"><link rel="prefetch" href="/assets/js/39.78160c0e.js"><link rel="prefetch" href="/assets/js/40.382841f8.js"><link rel="prefetch" href="/assets/js/41.885f2f51.js"><link rel="prefetch" href="/assets/js/42.f80a1c3b.js"><link rel="prefetch" href="/assets/js/43.2d69a52c.js"><link rel="prefetch" href="/assets/js/44.f4b824cb.js"><link rel="prefetch" href="/assets/js/45.62271286.js"><link rel="prefetch" href="/assets/js/46.d2488a8c.js"><link rel="prefetch" href="/assets/js/47.9557b14d.js"><link rel="prefetch" href="/assets/js/48.7d7ec08a.js"><link rel="prefetch" href="/assets/js/49.d73d6eec.js"><link rel="prefetch" href="/assets/js/5.780a742d.js"><link rel="prefetch" href="/assets/js/50.68c5e2b1.js"><link rel="prefetch" href="/assets/js/51.ffd05e1e.js"><link rel="prefetch" href="/assets/js/52.8b67bfc4.js"><link rel="prefetch" href="/assets/js/53.3e90e7f7.js"><link rel="prefetch" href="/assets/js/54.da160b30.js"><link rel="prefetch" href="/assets/js/55.c01fe65c.js"><link rel="prefetch" href="/assets/js/56.9cef0001.js"><link rel="prefetch" href="/assets/js/57.e1685918.js"><link rel="prefetch" href="/assets/js/58.fdc9435f.js"><link rel="prefetch" href="/assets/js/59.2b47562d.js"><link rel="prefetch" href="/assets/js/6.6c206683.js"><link rel="prefetch" href="/assets/js/60.3acec2d6.js"><link rel="prefetch" href="/assets/js/61.460bdb9c.js"><link rel="prefetch" href="/assets/js/62.a15c3ffa.js"><link rel="prefetch" href="/assets/js/63.d178adeb.js"><link rel="prefetch" href="/assets/js/64.7987fd77.js"><link rel="prefetch" href="/assets/js/65.e9e95e83.js"><link rel="prefetch" href="/assets/js/66.64af357b.js"><link rel="prefetch" href="/assets/js/67.f374f0d9.js"><link rel="prefetch" href="/assets/js/68.c2233d35.js"><link rel="prefetch" href="/assets/js/69.a7a5659d.js"><link rel="prefetch" href="/assets/js/7.03420b55.js"><link rel="prefetch" href="/assets/js/70.5ce341df.js"><link rel="prefetch" href="/assets/js/71.e3e48338.js"><link rel="prefetch" href="/assets/js/72.84c288fb.js"><link rel="prefetch" href="/assets/js/73.6a7a889e.js"><link rel="prefetch" href="/assets/js/74.14998524.js"><link rel="prefetch" href="/assets/js/75.ee549f14.js"><link rel="prefetch" href="/assets/js/76.25e70571.js"><link rel="prefetch" href="/assets/js/77.4d5c1e59.js"><link rel="prefetch" href="/assets/js/78.9ef506e7.js"><link rel="prefetch" href="/assets/js/79.d8ce5edc.js"><link rel="prefetch" href="/assets/js/80.4f28b4e4.js"><link rel="prefetch" href="/assets/js/81.1b7d14fe.js"><link rel="prefetch" href="/assets/js/82.1079fef2.js"><link rel="prefetch" href="/assets/js/83.8e3c662c.js"><link rel="prefetch" href="/assets/js/84.7ebf4f02.js"><link rel="prefetch" href="/assets/js/85.ef90f7a4.js"><link rel="prefetch" href="/assets/js/86.6cbc081e.js"><link rel="prefetch" href="/assets/js/87.ec5eefd3.js"><link rel="prefetch" href="/assets/js/88.b868526a.js"><link rel="prefetch" href="/assets/js/89.784374db.js"><link rel="prefetch" href="/assets/js/90.ae898fe0.js"><link rel="prefetch" href="/assets/js/91.33b7f1ba.js"><link rel="prefetch" href="/assets/js/92.71d5cf4a.js"><link rel="prefetch" href="/assets/js/93.7b66f316.js"><link rel="prefetch" href="/assets/js/94.603a681b.js"><link rel="prefetch" href="/assets/js/95.3f701e9c.js"><link rel="prefetch" href="/assets/js/96.00d8e922.js"><link rel="prefetch" href="/assets/js/97.984ad933.js"><link rel="prefetch" href="/assets/js/98.c1f70ac1.js"><link rel="prefetch" href="/assets/js/99.fa521847.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.caeb3b49.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a3990aec.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpeg" alt="Pursuit's blog" class="logo"> <span class="site-name can-hide">Pursuit's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发" class="dropdown-title"><a href="/develop/" class="link-title">开发</a> <span class="title" style="display:none;">开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/develop/language/" class="nav-link">编程语言</a></li><li class="dropdown-item"><!----> <a href="/develop/framework/" class="nav-link">开发框架</a></li><li class="dropdown-item"><!----> <a href="/develop/algorithm/" class="nav-link">数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/develop/storage/" class="nav-link">数据存储</a></li><li class="dropdown-item"><!----> <a href="/develop/system/" class="nav-link">系统架构</a></li><li class="dropdown-item"><!----> <a href="/develop/network/" class="nav-link">计算机网络</a></li><li class="dropdown-item"><!----> <a href="/develop/cloud/" class="nav-link">云原生</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><a href="/tool/" class="link-title">工具</a> <span class="title" style="display:none;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tool/vcs/" class="nav-link">版本控制</a></li><li class="dropdown-item"><!----> <a href="/tool/network/" class="nav-link">网络工具</a></li><li class="dropdown-item"><!----> <a href="/tool/develop/" class="nav-link">开发工具</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><a href="/note/" class="link-title">学习笔记</a> <span class="title" style="display:none;">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/paper/" class="nav-link">学术搬砖</a></li><li class="dropdown-item"><!----> <a href="/note/project/" class="nav-link">实践项目</a></li><li class="dropdown-item"><!----> <a href="/note/lecture/" class="nav-link">讲座研讨</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="生活杂谈" class="dropdown-title"><a href="/life/" class="link-title">生活杂谈</a> <span class="title" style="display:none;">生活杂谈</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/life/year/" class="nav-link">随写编年</a></li><li class="dropdown-item"><!----> <a href="/life/youth/" class="nav-link">追忆青春</a></li><li class="dropdown-item"><!----> <a href="/life/travel/" class="nav-link">旅行日记</a></li><li class="dropdown-item"><!----> <a href="/life/art/" class="nav-link">文艺时光</a></li><li class="dropdown-item"><!----> <a href="/life/cook/" class="nav-link">烹调分享</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="资源收藏" class="dropdown-title"><a href="/resource/" class="link-title">资源收藏</a> <span class="title" style="display:none;">资源收藏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/resource/website/" class="nav-link">实用网站</a></li><li class="dropdown-item"><!----> <a href="/resource/project/" class="nav-link">优秀项目</a></li><li class="dropdown-item"><!----> <a href="/resource/study/" class="nav-link">学习资源</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/more/interview/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/more/tip/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/more/blog/" class="nav-link">博客相关</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friend/" class="nav-link">友链</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/unique-pure/my-vdoing-blog-template" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar.jpeg"> <div class="blogger-info"><h3>Pursuit</h3> <span>但行好事，莫问前程</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发" class="dropdown-title"><a href="/develop/" class="link-title">开发</a> <span class="title" style="display:none;">开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/develop/language/" class="nav-link">编程语言</a></li><li class="dropdown-item"><!----> <a href="/develop/framework/" class="nav-link">开发框架</a></li><li class="dropdown-item"><!----> <a href="/develop/algorithm/" class="nav-link">数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/develop/storage/" class="nav-link">数据存储</a></li><li class="dropdown-item"><!----> <a href="/develop/system/" class="nav-link">系统架构</a></li><li class="dropdown-item"><!----> <a href="/develop/network/" class="nav-link">计算机网络</a></li><li class="dropdown-item"><!----> <a href="/develop/cloud/" class="nav-link">云原生</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><a href="/tool/" class="link-title">工具</a> <span class="title" style="display:none;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tool/vcs/" class="nav-link">版本控制</a></li><li class="dropdown-item"><!----> <a href="/tool/network/" class="nav-link">网络工具</a></li><li class="dropdown-item"><!----> <a href="/tool/develop/" class="nav-link">开发工具</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><a href="/note/" class="link-title">学习笔记</a> <span class="title" style="display:none;">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/paper/" class="nav-link">学术搬砖</a></li><li class="dropdown-item"><!----> <a href="/note/project/" class="nav-link">实践项目</a></li><li class="dropdown-item"><!----> <a href="/note/lecture/" class="nav-link">讲座研讨</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="生活杂谈" class="dropdown-title"><a href="/life/" class="link-title">生活杂谈</a> <span class="title" style="display:none;">生活杂谈</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/life/year/" class="nav-link">随写编年</a></li><li class="dropdown-item"><!----> <a href="/life/youth/" class="nav-link">追忆青春</a></li><li class="dropdown-item"><!----> <a href="/life/travel/" class="nav-link">旅行日记</a></li><li class="dropdown-item"><!----> <a href="/life/art/" class="nav-link">文艺时光</a></li><li class="dropdown-item"><!----> <a href="/life/cook/" class="nav-link">烹调分享</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="资源收藏" class="dropdown-title"><a href="/resource/" class="link-title">资源收藏</a> <span class="title" style="display:none;">资源收藏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/resource/website/" class="nav-link">实用网站</a></li><li class="dropdown-item"><!----> <a href="/resource/project/" class="nav-link">优秀项目</a></li><li class="dropdown-item"><!----> <a href="/resource/study/" class="nav-link">学习资源</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/more/interview/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/more/tip/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/more/blog/" class="nav-link">博客相关</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friend/" class="nav-link">友链</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/unique-pure/my-vdoing-blog-template" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程语言</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>开发框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据结构与算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据存储</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>系统架构</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>操作系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>分布式系统</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d0e06c/" class="sidebar-link">MIT 6.5840(6.824) 分布式系统介绍</a></li><li><a href="/pages/5760f4/" aria-current="page" class="active sidebar-link">MIT 6.5840(6.824) 使用Go进行线程和RPC编程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/5760f4/#_1-为什么选择go" class="sidebar-link">1 为什么选择Go</a></li><li class="sidebar-sub-header level2"><a href="/pages/5760f4/#_2-线程与go中的goroutine" class="sidebar-link">2 线程与Go中的Goroutine</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/5760f4/#_2-1-为什么使用线程" class="sidebar-link">2.1 为什么使用线程？</a></li><li class="sidebar-sub-header level3"><a href="/pages/5760f4/#_2-2-线程的替代方案" class="sidebar-link">2.2 线程的替代方案</a></li><li class="sidebar-sub-header level3"><a href="/pages/5760f4/#_2-3-线程编程挑战" class="sidebar-link">2.3 线程编程挑战</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/5760f4/#_3-以网络爬虫为例的线程应用" class="sidebar-link">3 以网络爬虫为例的线程应用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/5760f4/#_3-1-串行爬虫" class="sidebar-link">3.1 串行爬虫</a></li><li class="sidebar-sub-header level3"><a href="/pages/5760f4/#_3-2-并发爬虫" class="sidebar-link">3.2 并发爬虫</a></li><li class="sidebar-sub-header level3"><a href="/pages/5760f4/#_3-2-1-使用锁" class="sidebar-link">3.2.1 使用锁</a></li><li class="sidebar-sub-header level3"><a href="/pages/5760f4/#_3-2-2-使用通道" class="sidebar-link">3.2.2 使用通道</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/5760f4/#_4-远程过程调用-rpc" class="sidebar-link">4 远程过程调用（RPC）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/5760f4/#_4-1-介绍" class="sidebar-link">4.1 介绍</a></li><li class="sidebar-sub-header level3"><a href="/pages/5760f4/#_4-1-远程过程调用-rpc" class="sidebar-link">4.1 远程过程调用（RPC）</a></li><li class="sidebar-sub-header level3"><a href="/pages/5760f4/#_4-2-go的rpc实现" class="sidebar-link">4.2 Go的RPC实现</a></li><li class="sidebar-sub-header level3"><a href="/pages/5760f4/#_4-3-处理rpc中的失败" class="sidebar-link">4.3 处理RPC中的失败</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/5760f4/#_5-faq" class="sidebar-link">5 FAQ</a></li></ul></li><li><a href="/pages/676f11/" class="sidebar-link">MIT 6.5840(6.824) 测试分布式系统的线性一致性</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>云原生</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/develop/#开发" data-v-06225672>开发</a></li><li data-v-06225672><a href="/develop/#系统架构" data-v-06225672>系统架构</a></li><li data-v-06225672><a href="/develop/#分布式系统" data-v-06225672>分布式系统</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/unique-pure" target="_blank" title="作者" class="beLink" data-v-06225672>Pursuit</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-05-15</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">MIT 6.5840(6.824) 使用Go进行线程和RPC编程<!----></h1>  <div class="theme-vdoing-content content__default"><h2 id="_1-为什么选择go"><a href="#_1-为什么选择go" class="header-anchor">#</a> 1 为什么选择Go</h2> <p>在实现分布式系统时，选择合适的编程语言非常重要。Go有以下特点：</p> <ul><li>优秀的线程支持；</li> <li>便捷的RPC机制、类型；</li> <li>内存安全以及垃圾回收机制。</li></ul> <p>这使Go成为了一个理想的选择。Go不仅相对简单，而且其垃圾回收机制使线程管理更加容易，避免了使用后释放问题。由于这些优势，Go在分布式系统中被广泛应用。</p> <p><a href="https://golang.org/doc/effective_go.html" target="_blank" rel="noopener noreferrer">Go Tutorial<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="_2-线程与go中的goroutine"><a href="#_2-线程与go中的goroutine" class="header-anchor">#</a> 2 线程与Go中的Goroutine</h2> <p>线程是一种有用的结构工具，允许一个程序同时执行多项任务，每个线程串行执行，就像非线程程序一样。Go中称线程为Goroutine，每个Goroutine在执行时包含自己的程序计数器、寄存器和栈，但共享内存。使用线程可以提高I/O并发性和多核性能，同时也方便后台任务的处理。</p> <h3 id="_2-1-为什么使用线程"><a href="#_2-1-为什么使用线程" class="header-anchor">#</a> 2.1 为什么使用线程？</h3> <ol><li><strong>I/O并发性</strong>：客户端可以并行向多个服务器发送请求并等待回复，服务器可以同时处理多个客户端请求。</li> <li><strong>多核性能</strong>：在多核处理器上并行执行代码，提高计算效率。</li> <li><strong>便捷性</strong>：后台线程可以定期检查各个<code>worker</code>线程是否仍然活跃。</li></ol> <h3 id="_2-2-线程的替代方案"><a href="#_2-2-线程的替代方案" class="header-anchor">#</a> 2.2 线程的替代方案</h3> <p>事件驱动编程（Event-driven programming）是一种替代传统多线程编程的方式，通过在单线程中显式交错处理活动来实现I/O并发性。这种编程模型常用于处理大量I/O操作的场景，例如网络服务器和图形用户界面（GUI）应用。</p> <p>在事件驱动编程中，系统维护一个事件循环（event loop），不断检查并处理事件队列中的事件。每个事件通常对应某种外部输入或状态变化，如网络请求到达、用户点击按钮或定时器到期。事件处理程序（event handler）被注册到特定事件上，当相应事件发生时，处理程序被调用来执行预定义的操作。</p> <h3 id="_2-3-线程编程挑战"><a href="#_2-3-线程编程挑战" class="header-anchor">#</a> 2.3 线程编程挑战</h3> <ol><li><strong>安全共享数据</strong>：多个线程同时访问共享数据时可能导致竞争条件，常用的解决方案是使用锁（如Go的<code>sync.Mutex</code>）或者避免共享可变数据。</li> <li><strong>线程间协调</strong>：一个线程生产数据，另一个线程消费数据，需要使用Go的通道（<code>channel</code>）或条件变量（<code>sync.Cond</code>）或等待组（<code>sync.WaitGroup</code>）进行协调。</li> <li><strong>死锁</strong>：线程之间通过锁或<code>channel</code>或RPC相互等待资源时可能导致死锁，需要小心避免。</li></ol> <h2 id="_3-以网络爬虫为例的线程应用"><a href="#_3-以网络爬虫为例的线程应用" class="header-anchor">#</a> 3 以网络爬虫为例的线程应用</h2> <p>网络爬虫的目标是抓取所有网页内容，常见的实现方式有串行和并发两种。并发爬虫利用线程提高抓取效率，但也需要解决避免重复抓取和循环依赖的问题。</p> <p>在本例中，我们使用一个填充的<code>Fetcher</code>来模拟抓取。<code>fetcher</code>结构如下：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> fakeResult <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	body <span class="token builtin">string</span>
	urls <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>f fakeFetcher<span class="token punctuation">)</span> <span class="token function">Fetch</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> res<span class="token punctuation">,</span> ok <span class="token operator">:=</span> f<span class="token punctuation">[</span>url<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;found:   %s\n&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
		<span class="token keyword">return</span> res<span class="token punctuation">.</span>urls<span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;missing: %s\n&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;not found: %s&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// fetcher is a populated fakeFetcher.</span>
<span class="token keyword">var</span> fetcher <span class="token operator">=</span> fakeFetcher<span class="token punctuation">{</span>
	<span class="token string">&quot;http://golang.org/&quot;</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>fakeResult<span class="token punctuation">{</span>
		<span class="token string">&quot;The Go Programming Language&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
			<span class="token string">&quot;http://golang.org/pkg/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;http://golang.org/cmd/&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string">&quot;http://golang.org/pkg/&quot;</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>fakeResult<span class="token punctuation">{</span>
		<span class="token string">&quot;Packages&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
			<span class="token string">&quot;http://golang.org/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;http://golang.org/cmd/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;http://golang.org/pkg/fmt/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;http://golang.org/pkg/os/&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string">&quot;http://golang.org/pkg/fmt/&quot;</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>fakeResult<span class="token punctuation">{</span>
		<span class="token string">&quot;Package fmt&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
			<span class="token string">&quot;http://golang.org/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;http://golang.org/pkg/&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string">&quot;http://golang.org/pkg/os/&quot;</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>fakeResult<span class="token punctuation">{</span>
		<span class="token string">&quot;Package os&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
			<span class="token string">&quot;http://golang.org/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;http://golang.org/pkg/&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h3 id="_3-1-串行爬虫"><a href="#_3-1-串行爬虫" class="header-anchor">#</a> 3.1 串行爬虫</h3> <p>串行爬虫通过递归调用实现深度优先搜索，使用一个共享的map记录已抓取的URL，防止重复抓取。然而，这种方式只能一次抓取一个页面，速度较慢。代码如下：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Serial</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">,</span> fetcher Fetcher<span class="token punctuation">,</span> fetched <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Use a map to keep track of fetched URLs</span>
	<span class="token keyword">if</span> fetched<span class="token punctuation">[</span>url<span class="token punctuation">]</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	fetched<span class="token punctuation">[</span>url<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
	urls<span class="token punctuation">,</span> err <span class="token operator">:=</span> fetcher<span class="token punctuation">.</span><span class="token function">Fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Recursively fetch URLs</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> u <span class="token operator">:=</span> <span class="token keyword">range</span> urls <span class="token punctuation">{</span>
		<span class="token function">Serial</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> fetcher<span class="token punctuation">,</span> fetched<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><blockquote><p>我们是否可以在<code>Serial()</code>调用前面放一个<code>go</code>呢</p></blockquote> <p>在 <code>Serial()</code> 调用前添加 <code>go</code> 关键字会导致并发执行多个爬虫任务，从而可能导致重复抓取相同的页面。这是因为每个爬虫任务都会尝试从未抓取过的页面开始递归抓取，而并发执行可能导致多个爬虫同时选择相同的页面作为起始点，进而重复抓取。</p> <h3 id="_3-2-并发爬虫"><a href="#_3-2-并发爬虫" class="header-anchor">#</a> 3.2 并发爬虫</h3> <h3 id="_3-2-1-使用锁"><a href="#_3-2-1-使用锁" class="header-anchor">#</a> 3.2.1 使用锁</h3> <p>每个页面的抓取在独立的线程中进行，为了确保抓取过程的正确性，我们使用了互斥锁来保护共享的 <code>fetchState</code> 结构体，避免了重复抓取和并发冲突的问题。在抓取过程中，我们使用了递归调用 <code>ConcurrentMutex</code> 函数来处理当前页面的所有子链接。每当发现一个新的子链接时，我们启动一个新的 Goroutine 来并发地抓取该链接，从而实现了多个页面的并行抓取。使用 <code>sync.WaitGroup</code> 来等待所有的子链接抓取任务完成，确保主线程在所有任务完成后才返回，以避免提前结束抓取过程。代码如下：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> fetchState <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	mu      sync<span class="token punctuation">.</span>Mutex      <span class="token comment">// protect concurrent crawls</span>
	fetched <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">bool</span> <span class="token comment">// Used to store crawled URLs. The key is URL and the value is whether it has been crawled.</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>fs <span class="token operator">*</span>fetchState<span class="token punctuation">)</span> <span class="token function">testAndSet</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	fs<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> fs<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	r <span class="token operator">:=</span> fs<span class="token punctuation">.</span>fetched<span class="token punctuation">[</span>url<span class="token punctuation">]</span>
	fs<span class="token punctuation">.</span>fetched<span class="token punctuation">[</span>url<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
	<span class="token keyword">return</span> r <span class="token comment">// Return to previous crawling status</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ConcurrentMutex</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">,</span> fetcher Fetcher<span class="token punctuation">,</span> fs <span class="token operator">*</span>fetchState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> fs<span class="token punctuation">.</span><span class="token function">testAndSet</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	urls<span class="token punctuation">,</span> err <span class="token operator">:=</span> fetcher<span class="token punctuation">.</span><span class="token function">Fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">var</span> done sync<span class="token punctuation">.</span>WaitGroup <span class="token comment">// Create a wait group that waits for all subtasks to complete</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> u <span class="token operator">:=</span> <span class="token keyword">range</span> urls <span class="token punctuation">{</span>
		done<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>         <span class="token comment">// Increase the counter of the waiting group</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>u <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Start a Go coroutine to concurrently crawl sub-links</span>
			<span class="token keyword">defer</span> done<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token function">ConcurrentMutex</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> fetcher<span class="token punctuation">,</span> fs<span class="token punctuation">)</span> <span class="token comment">// Recursive call ConcurrentMutex, fetching sub-links.</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	done<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Wait for all subtasks to complete</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h3 id="_3-2-2-使用通道"><a href="#_3-2-2-使用通道" class="header-anchor">#</a> 3.2.2 使用通道</h3> <p>每个<code>worker</code>线程将抓取到的URL发送到一个通道，<code>coordinator</code>从通道中读取URL并启动新的<code>worker</code>线程。这种方式避免了锁的使用，但需要小心避免通道阻塞导致的死锁。代码如下：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">,</span> ch <span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> fetcher Fetcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	urls<span class="token punctuation">,</span> err <span class="token operator">:=</span> fetcher<span class="token punctuation">.</span><span class="token function">Fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		ch <span class="token operator">&lt;-</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		ch <span class="token operator">&lt;-</span> urls
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">coordinator</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> fetcher Fetcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	n <span class="token operator">:=</span> <span class="token number">1</span>                           <span class="token comment">// 记录正在处理的任务数量，初始值为 1，因为最开始只有一个初始 URL</span>
	fetched <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token comment">// 记录已经抓取的 URL</span>
	<span class="token keyword">for</span> urls <span class="token operator">:=</span> <span class="token keyword">range</span> ch <span class="token punctuation">{</span>           <span class="token comment">// 不断从通道中接收抓取到的链接列表，直到通道被关闭</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> u <span class="token operator">:=</span> <span class="token keyword">range</span> urls <span class="token punctuation">{</span> <span class="token comment">// 遍历接收到的链接列表</span>
			<span class="token keyword">if</span> fetched<span class="token punctuation">[</span>u<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token punctuation">{</span>
				fetched<span class="token punctuation">[</span>u<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
				n <span class="token operator">+=</span> <span class="token number">1</span>
				<span class="token keyword">go</span> <span class="token function">worker</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> ch<span class="token punctuation">,</span> fetcher<span class="token punctuation">)</span> <span class="token comment">// 启动一个新的 worker 协程抓取该链接的子链接</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		n <span class="token operator">-=</span> <span class="token number">1</span>
		<span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span> <span class="token comment">// 如果当前没有正在处理的任务，则退出循环，结束并发抓取过程</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// ConcurrentChannel 函数是并发抓取的入口函数，利用通道协调并发抓取的过程。</span>
<span class="token keyword">func</span> <span class="token function">ConcurrentChannel</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">,</span> fetcher Fetcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token comment">// 创建一个字符串切片类型的通道</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>               <span class="token comment">// 启动一个匿名函数的 Go 协程，用于向通道发送 URL</span>
		ch <span class="token operator">&lt;-</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>url<span class="token punctuation">}</span> <span class="token comment">// 向通道发送包含初始 URL 的字符串切片</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">coordinator</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> fetcher<span class="token punctuation">)</span> <span class="token comment">// 调用 coordinator 函数，开始并发抓取的协调过程</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>在 <code>worker</code> 函数中，每个<code>worker</code>线程会尝试抓取指定的URL，并将抓取到的子链接发送到通道中。如果抓取失败，则发送一个空的字符串切片到通道，以便通知<code>coordinator</code>任务失败。</p> <p>在 <code>coordinator</code> 函数中，<code>coordinator</code>不断从通道中读取抓取到的链接列表，然后遍历这些链接，如果发现之前未抓取过的新链接，则将其标记为已抓取并启动一个新的<code>worker</code>线程进行抓取。同时，<code>coordinator</code>会维护一个计数器 <code>n</code> 来记录当前正在处理的任务数量，当所有任务都处理完成后，<code>coordinator</code>结束并发抓取的过程。</p> <p>在 <code>ConcurrentChannel</code> 函数中，我们首先创建了一个字符串切片类型的通道，并启动了一个匿名的 Goroutine 来向通道发送初始的 URL。然后，调用 <code>coordinator</code> 函数开始并发抓取的协调过程。</p> <blockquote><ol><li><code>coordinator</code>如何知道它已经完成？</li></ol> <p><code>coordinator</code>知道它已完成的条件是 <code>n</code> 计数器的值归零。<code>coordinator</code>通过维护 <code>n</code> 计数器来跟踪当前正在处理的任务数量，每个<code>worker</code>线程处理完成后会将 <code>n</code> 减一。当 <code>n</code> 计数器的值为零时，表示所有的任务都已经完成，<code>coordinator</code>就知道自己的工作已经完成。</p> <ol start="2"><li>通道在这里有两个作用：</li></ol> <ul><li>通信值：<code>worker</code>线程将抓取到的链接列表发送到通道中，以便<code>coordinator</code>可以读取并处理。</li> <li>事件通知：通道的关闭可作为事件通知，当通道关闭时，<code>coordinator</code>会知道所有的<code>worker</code>线程都已完成，并且没有新的任务需要处理。</li></ul></blockquote> <h2 id="_4-远程过程调用-rpc"><a href="#_4-远程过程调用-rpc" class="header-anchor">#</a> 4 远程过程调用（RPC）</h2> <h3 id="_4-1-介绍"><a href="#_4-1-介绍" class="header-anchor">#</a> 4.1 介绍</h3> <h3 id="_4-1-远程过程调用-rpc"><a href="#_4-1-远程过程调用-rpc" class="header-anchor">#</a> 4.1 远程过程调用（RPC）</h3> <p>远程过程调用（RPC）是分布式系统中的关键技术之一，它使得客户端和服务器之间的通信变得简单而直观。在分布式系统中，不同的节点可能分布在不同的物理机器上，RPC允许这些节点之间进行远程通信，就像调用本地函数一样，无需了解底层的网络协议细节。</p> <p>RPC的目标是实现易于编程的客户端/服务器通信，它隐藏了底层网络通信的复杂性，为开发人员提供了简单的接口。通过RPC，开发人员可以专注于业务逻辑的实现，而无需担心网络通信的细节。</p> <p>在RPC中，数据在客户端和服务器之间通过网络传输，因此需要将数据转换为“有线格式”（wire format）。RPC库负责处理数据的序列化和反序列化，以确保数据可以在网络上传输并在另一端正确解析。</p> <p>RPC消息的基本结构是请求-响应模式。<font color="red">客户端发送请求给服务器，服务器处理请求并发送响应给客户端。</font>这种简单的请求-响应模式使得RPC成为了一种非常有效的通信方式。</p> <p>在RPC的软件结构中，通常会有以下几个组件：</p> <ul><li>客户端应用程序：负责发起RPC请求的应用程序。</li> <li>存根函数（Stub functions）：客户端应用程序调用的接口函数，实际上是一个本地代理，负责将RPC调用转发给远程服务器。</li> <li>服务器处理函数（Handler functions）：服务器端实际执行业务逻辑的函数。</li> <li>调度器（Dispatcher）：负责将RPC请求分发给正确的处理函数。</li> <li>RPC库：提供了RPC通信所需的基本功能，例如序列化、网络通信等。</li></ul> <p>通过RPC，不同语言编写的客户端和服务器可以进行通信，实现了跨语言的可移植性和互操作性。</p> <h3 id="_4-2-go的rpc实现"><a href="#_4-2-go的rpc实现" class="header-anchor">#</a> 4.2 Go的RPC实现</h3> <p>在Go中，实现RPC需要定义请求和回复的结构体，并使用Go的RPC库来处理通信。下面是一个示例，展示了如何在Go中实现一个简单的键值存储服务器（key/value storage server），并使用RPC进行通信。</p> <ul><li><p>请求回复结构体</p> <p>在键值存储服务器的示例中，我们定义了用于Put和Get操作的请求和回复结构体：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> PutArgs <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Key   <span class="token builtin">string</span>
	Value <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> PutReply <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> GetArgs <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Key <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> GetReply <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Value <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li> <li><p>服务器端（Server）</p> <p>在服务器端，首先需要定义一个对象，并在该对象上注册处理函数作为RPC处理程序。这些处理函数将处理客户端发送的RPC请求。服务器接受TCP连接并将其传递给RPC库。RPC库负责读取每个请求，并为每个请求创建一个新的Goroutine进行处理。处理函数会读取请求参数，并根据请求调用相应的方法。处理完请求后，服务器将回复信息进行序列化，并通过TCP连接发送回客户端。<font color="red">服务器端的处理函数必须使用锁进行同步，因为RPC库为每个请求创建了一个新的Goroutine。</font>处理函数需要读取请求参数并修改回复信息，因此需要确保并发访问的安全性。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> KV <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	mu   sync<span class="token punctuation">.</span>Mutex <span class="token comment">// 互斥锁，保护数据并发访问</span>
	data <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">server</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	kv <span class="token operator">:=</span> <span class="token operator">&amp;</span>KV<span class="token punctuation">{</span>data<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token comment">// 创建键值存储服务器实例</span>
	rpcs <span class="token operator">:=</span> rpc<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>              <span class="token comment">// 创建一个 RPC 服务器</span>
	rpcs<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>kv<span class="token punctuation">)</span>                    <span class="token comment">// 注册 kv 为 RPC 服务器的服务对象</span>
	l<span class="token punctuation">,</span> e <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;:1234&quot;</span><span class="token punctuation">)</span>   <span class="token comment">// 监听 TCP 端口 1234</span>
	<span class="token keyword">if</span> e <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;listen error:&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 启动一个协程来处理客户端连接</span>
		<span class="token keyword">for</span> <span class="token punctuation">{</span>
			conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 接受客户端连接</span>
			<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">go</span> rpcs<span class="token punctuation">.</span><span class="token function">ServeConn</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span> <span class="token comment">// 启动一个协程来为客户端提供服务</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		l<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 关闭监听器</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Get 方法用于处理客户端发送的 Get 请求，获取指定键的值。</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KV<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>args <span class="token operator">*</span>GetArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>GetReply<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	reply<span class="token punctuation">.</span>Value <span class="token operator">=</span> kv<span class="token punctuation">.</span>data<span class="token punctuation">[</span>args<span class="token punctuation">.</span>Key<span class="token punctuation">]</span>

	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// Put 方法用于处理客户端发送的 Put 请求，存储键值对。</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KV<span class="token punctuation">)</span> <span class="token function">Put</span><span class="token punctuation">(</span>args <span class="token operator">*</span>PutArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>PutReply<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	kv<span class="token punctuation">.</span>data<span class="token punctuation">[</span>args<span class="token punctuation">.</span>Key<span class="token punctuation">]</span> <span class="token operator">=</span> args<span class="token punctuation">.</span>Value

	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div></li> <li><p>客户端（Client）</p> <p>在客户端，首先需要使用Dial函数建立与服务器的TCP连接。然后，客户端需要定义RPC请求的参数结构体和回复结构体，并实现对应的处理函数。客户端通过调用Call函数发起RPC调用，指定连接、函数名称、参数以及存放回复的位置。RPC库负责对参数进行序列化，并将请求发送给服务器。然后，客户端等待并接收服务器的回复，并将回复反序列化为指定的回复结构体。Call函数的返回值指示是否成功接收到了回复，通常还包括服务级别的错误信息。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// connect 函数用于与键值存储服务器建立连接，并返回一个 RPC 客户端对象。</span>
<span class="token keyword">func</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>rpc<span class="token punctuation">.</span>Client <span class="token punctuation">{</span>
	client<span class="token punctuation">,</span> err <span class="token operator">:=</span> rpc<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;:1234&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 使用 TCP 协议连接服务器</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;dialing:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token comment">// 如果连接失败，则记录错误并终止程序</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> client
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">get</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	client <span class="token operator">:=</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                         <span class="token comment">// 建立连接</span>
	args <span class="token operator">:=</span> GetArgs<span class="token punctuation">{</span>key<span class="token punctuation">}</span>                        <span class="token comment">// 构造 Get 请求的参数</span>
	reply <span class="token operator">:=</span> GetReply<span class="token punctuation">{</span><span class="token punctuation">}</span>                         <span class="token comment">// 准备接收服务器的响应</span>
	err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">&quot;KV.Get&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span> <span class="token comment">// 调用远程方法 Get，并传递参数 args，将响应写入 reply</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;error:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	client<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment">// 关闭连接</span>
	<span class="token keyword">return</span> reply<span class="token punctuation">.</span>Value <span class="token comment">// 返回服务器返回的值</span>
<span class="token punctuation">}</span>

<span class="token comment">// put 函数用于向键值存储服务器发送 Put 请求，存储键值对。</span>
<span class="token keyword">func</span> <span class="token function">put</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> val <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	client <span class="token operator">:=</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	args <span class="token operator">:=</span> PutArgs<span class="token punctuation">{</span>key<span class="token punctuation">,</span> val<span class="token punctuation">}</span>
	reply <span class="token operator">:=</span> PutReply<span class="token punctuation">{</span><span class="token punctuation">}</span>
	err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">&quot;KV.Put&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;error:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	client<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div></li></ul> <p>其他细节：</p> <ul><li><p>绑定（Binding）：客户端如何知道要与哪台服务器通信？</p> <p>在Go的RPC中，服务器的名称和端口是Dial函数的参数。在大型系统中，通常会有一种名称或配置服务器来管理这些信息。</p></li> <li><p>序列化（Marshalling）：数据格式化为数据包。Go的RPC库可以传递字符串、数组、对象、映射等类型的数据。Go通过复制指向的数据来传递指针，但不能传递通道或函数。RPC库只序列化导出字段（即大写字母开头的字段）。</p></li></ul> <h3 id="_4-3-处理rpc中的失败"><a href="#_4-3-处理rpc中的失败" class="header-anchor">#</a> 4.3 处理RPC中的失败</h3> <p>在分布式系统中，网络故障和服务器故障是不可避免的。简单的解决方案是“尽力而为”的RPC，即在超时后重试请求，但这可能导致重复操作。</p> <p>这种方法的缺点是，重试请求可能导致操作被重复执行。例如：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>client<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span><span class="token string">&quot;k&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
client<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span><span class="token string">&quot;k&quot;</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>如果第二个<code>Put</code>请求因网络故障重试多次，可能会导致不一致的结果：</p> <p>更好的解决方案是“至多一次”的RPC，“至多一次”的RPC通过以下机制实现更可靠的行为：</p> <ul><li>客户端在未收到响应时重新发送请求。</li> <li>服务器检测重复请求，并返回之前的响应，而不是重新执行处理函数。</li></ul> <p>为了检测重复请求，客户端在每个请求中包含一个唯一的ID（XID）。每个请求使用相同的 XID 重新发送服务器：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>if seen[xid] {
  reply = old[xid]
} else {
  reply = handler()
  old[xid] = reply
  seen[xid] = true
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>一些“至多一次”复杂性问题：</strong></p> <ul><li><p>如果两个客户端使用相同的XID？</p> <ul><li>解决方案：使用大随机数生成唯一ID。</li></ul></li> <li><p>如何避免seen[xid]表过大？</p> <ul><li>每个客户端有一个唯一ID，使用序列号。</li> <li>客户端在每次RPC中包含“已见到的最大回复”信息，类似于TCP序列号和确认号。</li></ul></li> <li><p><strong>服务器崩溃和重启：</strong></p> <ul><li><p>如果“至多一次”信息保存在内存中，服务器重启后将忘记这些信息，可能会接受重复请求。</p> <p>解决方案：将重复检测信息写入磁盘，或使用复制服务器同步这些信息。</p></li></ul></li></ul> <p>Go的RPC库是“至多一次”策略的简单实现：</p> <ul><li>打开TCP连接。</li> <li>将请求写入TCP连接。</li> <li>Go RPC从不重发请求，因此服务器不会看到重复请求。</li> <li>如果未收到回复，Go RPC代码返回错误（可能是由于TCP超时）。</li></ul> <blockquote><p>关于“恰好一次”的RPC</p> <p>“恰好一次”的RPC包括无限重试、重复检测和容错服务，这种方法更复杂，在实际系统中需要实现容错机制。</p> <p>例如，lab 4中将探讨“恰好一次”RPC的实现。</p></blockquote> <h2 id="_5-faq"><a href="#_5-faq" class="header-anchor">#</a> 5 FAQ</h2> <blockquote><ol><li>Go通道是如何工作的？Go如何确保它们在多个goroutines之间同步？</li></ol> <p>可以在<a href="https://go.dev/src/runtime/chan.go" target="_blank" rel="noopener noreferrer">这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>查看源码，尽管不易理解。高层次上，<font color="red">通道是一个包含缓冲区和锁的结构体</font>。发送到通道涉及获取锁，等待（可能释放CPU）直到某个线程接收，并交付消息。接收涉及获取锁并等待发送者。可以使用Go的sync.Mutex和sync.Cond自己实现通道。</p> <ol start="2"><li>我使用通道唤醒另一个goroutine，通过在通道上发送一个虚拟的bool值。但如果另一个goroutine已经在运行（因此没有在通道上接收），发送goroutine会阻塞。我应该怎么做？</li></ol> <p>尝试使用条件变量（Go的sync.Cond）而不是通道。条件变量非常适合通知可能（或可能不）等待某事的goroutines。由于通道是同步的，如果不确定通道另一端是否有goroutine在等待，使用通道会显得很尴尬。</p> <ol start="3"><li>如何让一个goroutine等待来自多个不同通道的输入？如果没有任何内容可读取，则尝试在任何一个通道上接收都会阻塞，从而阻止 goroutine 检查其他通道。</li></ol> <p>尝试为每个通道创建一个单独的goroutine，每个goroutine阻塞在其通道上。这不是总能实现，但在可行时通常是最简单的方法。否则，尝试使用Go的select。</p> <ol start="4"><li>什么时候应该使用sync.WaitGroup而不是通道？反之亦然？</li></ol> <p>WaitGroup用途较为特殊；它仅在等待一堆活动完成时有用。通道用途更广泛；例如，可以通过通道传递值。尽管比WaitGroup需要多写几行代码，但也可以使用通道等待多个goroutines。</p> <ol start="5"><li>如何创建一个通过互联网连接的Go通道？如何指定用于发送消息的协议？</li></ol> <p>Go通道仅在单个程序内工作；通道不能用于与其他程序或计算机通信。可以查看Go的RPC包，它允许你通过互联网与其他Go程序通信：
https://golang.org/pkg/net/rpc/</p> <ol start="6"><li>一些重要/有用的Go特定并发模式有哪些？</li></ol> <p>这是一个关于该主题的幻灯片，由Go专家编写：
https://talks.golang.org/2012/concurrency.slide</p> <ol start="7"><li>切片是如何实现的？</li></ol> <p>切片是一个对象，包含指向数组的指针以及该数组的开始和结束索引。这种安排允许多个切片共享一个底层数组，每个切片可能暴露数组元素的不同范围。这里有一个更详细的讨论：
https://blog.golang.org/go-slices-usage-and-internals
Go切片比Go数组更灵活，因为数组的大小是其类型的一部分，而以切片作为参数的函数可以接受任何长度的切片。</p> <ol start="8"><li>什么时候使用同步RPC调用，什么时候使用异步RPC调用？</li></ol> <p>大多数代码需要在继续执行前获得RPC回复；在这种情况下，使用同步RPC是合理的。但有时客户端希望启动许多并发RPC；在这种情况下，异步可能更好。或者客户端希望在等待RPC完成时做其他工作，可能是因为服务器很远（所以光速时间很高）或因为服务器可能不可达，从而RPC经历长时间的超时。我(Robert)从未在Go中使用异步RPC。当我想发送RPC但不必等待结果时，我创建一个goroutine，并让这个goroutine进行同步Call()。</p> <ol start="9"><li>开发人员在开始使用Go时常见的问题有哪些？</li></ol> <p>以下是一些常见问题：</p> <ul><li>未在并发访问时使用锁保护映射。使用Go的竞态检测器！</li> <li>使用通道时的死锁。</li> <li>在创建goroutine时未捕获变量。</li> <li>泄漏的goroutines。</li></ul> <ol start="10"><li>Go是否支持继承？（像Java/C++那样的“扩展”方式？）</li></ol> <p>Go不支持C++风格的继承，但有接口和嵌入结构体，可以完成在C++中使用继承的许多事情。这是Go设计中备受争议的部分；可以搜索“golang generics”。</p> <ol start="11"><li>我对选择值接收器或指针接收器仍有些困惑。能否提供一些具体的实际例子说明我们应该选择哪一个？</li></ol> <p>当你想修改接收器的状态时，必须使用指针接收器。如果结构体非常大，你可能想使用指针接收器，因为值接收器操作的是一个副本。如果两者都不适用，可以使用值接收器。然而，要小心使用值接收器；例如，如果结构体中有一个互斥锁，你不能将其作为值接收器，因为互斥锁会被复制，从而失去其作用。</p></blockquote></div></div> <div class="page-slot page-slot-bottom"><div class="donation">
      <button>打赏</button>
      <div class="main">
        <div class="pic">
          <img src="https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/wechatpay.jpeg" alt="微信">
          <img src="https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/zhifubaopay.jpeg" alt="支付宝">
        </div>
      </div>  
    </div></div> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F" title="标签">#分布式系统</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/05/15, 13:02:06</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/d0e06c/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">MIT 6.5840(6.824) 分布式系统介绍</div></a> <a href="/pages/676f11/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">MIT 6.5840(6.824) 测试分布式系统的线性一致性</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/d0e06c/" class="prev">MIT 6.5840(6.824) 分布式系统介绍</a></span> <span class="next"><a href="/pages/676f11/">MIT 6.5840(6.824) 测试分布式系统的线性一致性</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/676f11/"><div>
            MIT 6.5840(6.824) 测试分布式系统的线性一致性
            <!----></div></a> <span class="date">05-22</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/66dc64/"><div>
            MIT 6.5840(6.824) Lab2:KV Server 设计实现
            <!----></div></a> <span class="date">05-15</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/b81dcf/"><div>
            MIT 6.5840(6.824) Lab1:MapReduce 设计实现
            <!----></div></a> <span class="date">05-14</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:unique.hzf@gmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/unique-pure" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://pursuit.blog.csdn.net/" title="My CSDN" target="_blank" class="iconfont icon-csdn"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2020-2024
    <span>Pursuit | <a href="https://github.com/unique-pure/my-vdoing-blog-template/blob/main/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><!----><div></div><WebInfo></WebInfo><PageInfo></PageInfo><div></div></div></div>
    <script src="/assets/js/app.8593a971.js" defer></script><script src="/assets/js/4.71a85121.js" defer></script><script src="/assets/js/1.4a1189e9.js" defer></script><script src="/assets/js/3.bca043f9.js" defer></script><script src="/assets/js/142.eb9d5fe6.js" defer></script><script src="/assets/js/20.bc1029fc.js" defer></script>
  </body>
</html>
